<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Self-Employed Workbook - Process Workflow</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0f1a;
            --bg-secondary: #111827;
            --bg-card: #1a2234;
            --accent-blue: #3b82f6;
            --accent-teal: #14b8a6;
            --accent-amber: #f59e0b;
            --accent-rose: #f43f5e;
            --accent-green: #22c55e;
            --accent-purple: #8b5cf6;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-subtle: rgba(255,255,255,0.08);
            --sidebar-width: 280px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Breadcrumb */
        .breadcrumb {
            background: linear-gradient(90deg, #0d1525 0%, #1a2234 100%);
            padding: 14px 25px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.95rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1001;
            border-bottom: 1px solid var(--border-subtle);
        }

        .breadcrumb a {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 600;
            padding: 8px 16px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            transition: all 0.2s;
            border: 1px solid var(--border-subtle);
        }

        .breadcrumb a:hover {
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent-blue);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .breadcrumb .separator { color: var(--text-muted); font-size: 1.2rem; }
        .breadcrumb .current { color: var(--accent-amber); font-weight: 600; padding: 8px 16px; }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 54px;
            left: 0;
            width: var(--sidebar-width);
            height: calc(100vh - 54px);
            background: var(--bg-secondary);
            overflow-y: auto;
            z-index: 1000;
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 25px 20px;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid var(--border-subtle);
        }

        .sidebar-header h2 { color: var(--text-primary); font-size: 1.2rem; font-weight: 700; margin-bottom: 5px; }
        .sidebar-header p { color: var(--text-muted); font-size: 0.85rem; }

        /* Tab Switch */
        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-subtle);
        }

        .sidebar-tab {
            flex: 1;
            padding: 14px 10px;
            text-align: center;
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
            background: none;
            border-left: none;
            border-right: none;
            border-top: none;
        }

        .sidebar-tab:hover { background: rgba(255,255,255,0.03); color: var(--text-secondary); }
        .sidebar-tab.active { color: var(--accent-blue); border-bottom-color: var(--accent-blue); background: rgba(59, 130, 246, 0.08); }
        .sidebar-tab.agent-tab.active { color: var(--accent-purple); border-bottom-color: var(--accent-purple); background: rgba(139, 92, 246, 0.08); }

        .sidebar-nav { padding: 15px 0; flex: 1; overflow-y: auto; }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            color: var(--text-secondary);
            text-decoration: none;
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .nav-item:hover { background: rgba(255,255,255,0.03); color: var(--text-primary); }
        .nav-item.active { background: rgba(59, 130, 246, 0.1); border-left-color: var(--accent-blue); color: var(--text-primary); }

        .nav-number {
            background: rgba(255,255,255,0.1);
            color: var(--text-secondary);
            width: 28px;
            height: 28px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .nav-item.active .nav-number { background: var(--accent-blue); color: white; }
        .nav-label { font-size: 0.95rem; font-weight: 500; }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid var(--border-subtle);
            background: rgba(0,0,0,0.2);
        }

        .doc-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 14px 20px;
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-teal) 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            text-decoration: none;
            font-size: 0.95rem;
        }

        .doc-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3); }

        /* Main Content */
        .main-content { margin-left: var(--sidebar-width); padding: 80px 40px 40px 40px; }

        /* Tab Panels */
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        .header {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            padding: 35px;
            border-radius: 16px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(20, 184, 166, 0.08) 0%, transparent 50%);
            pointer-events: none;
        }

        .header h1 {
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 10px;
            position: relative;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-blue) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header .subtitle { color: var(--text-secondary); font-size: 1.1rem; position: relative; }

        .header .meta { display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap; position: relative; }

        .header .meta-item {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-subtle);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Legend */
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            padding: 18px 22px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            margin-bottom: 25px;
        }

        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--text-secondary); }
        .legend-color { width: 18px; height: 18px; border-radius: 4px; }

        /* Sections */
        .section {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            margin-bottom: 25px;
            overflow: hidden;
            scroll-margin-top: 75px;
        }

        .section-header {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(59, 130, 246, 0.1) 100%);
            border-bottom: 1px solid var(--border-subtle);
            padding: 22px 25px;
            display: flex;
            align-items: center;
            gap: 18px;
        }

        .section-number {
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-teal) 100%);
            color: white;
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1.3rem;
            flex-shrink: 0;
        }

        .section-title h2 { font-size: 1.35rem; font-weight: 700; margin-bottom: 4px; color: var(--text-primary); }
        .section-title span { font-size: 0.9rem; color: var(--text-muted); }
        .section-content { padding: 28px; }

        /* Workflow Diagrams */
        .workflow-diagram {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 28px;
            margin-bottom: 22px;
        }

        .flow-row { display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px; margin: 15px 0; }

        .flow-node {
            padding: 14px 22px;
            border-radius: 10px;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 600;
            min-width: 150px;
            border: 1px solid var(--border-subtle);
        }

        .flow-node.start { background: linear-gradient(135deg, var(--accent-green) 0%, #16a34a 100%); color: white; border-radius: 25px; border: none; }
        .flow-node.action { background: linear-gradient(135deg, var(--accent-blue) 0%, #2563eb 100%); color: white; border: none; }
        .flow-node.decision { background: linear-gradient(135deg, var(--accent-amber) 0%, #d97706 100%); color: var(--bg-primary); border: none; }
        .flow-node.input { background: var(--bg-secondary); border: 2px solid var(--accent-blue); color: var(--text-primary); }
        .flow-node.output { background: linear-gradient(135deg, var(--accent-teal) 0%, #0d9488 100%); color: white; border: none; }
        .flow-node.exception { background: linear-gradient(135deg, var(--accent-rose) 0%, #dc2626 100%); color: white; border: none; }

        .flow-arrow { color: var(--accent-blue); font-size: 1.5rem; }
        .flow-arrow.down { transform: rotate(90deg); }

        .decision-branch { display: flex; gap: 40px; justify-content: center; margin: 20px 0; flex-wrap: wrap; }
        .branch { display: flex; flex-direction: column; align-items: center; gap: 10px; }

        .branch-label {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--text-secondary);
        }

        /* Tables */
        .field-table { width: 100%; border-collapse: collapse; margin: 18px 0; }

        .field-table th {
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent-blue);
            padding: 14px 18px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border-subtle);
        }

        .field-table td { padding: 14px 18px; border-bottom: 1px solid var(--border-subtle); color: var(--text-secondary); }
        .field-table tr:hover { background: rgba(255,255,255,0.02); }

        .badge { display: inline-block; padding: 4px 12px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
        .badge.required-badge { background: rgba(244, 63, 94, 0.15); color: var(--accent-rose); }
        .badge.optional-badge { background: rgba(34, 197, 94, 0.15); color: var(--accent-green); }
        .badge.calculated-badge { background: rgba(59, 130, 246, 0.15); color: var(--accent-blue); }

        /* Info Boxes */
        .exception-box, .tip-box, .info-box {
            padding: 18px 22px;
            margin: 18px 0;
            border-radius: 0 10px 10px 0;
            border-left-width: 4px;
            border-left-style: solid;
        }

        .exception-box { background: rgba(244, 63, 94, 0.08); border-color: var(--accent-rose); border: 1px solid rgba(244, 63, 94, 0.2); border-left: 4px solid var(--accent-rose); }
        .exception-box h4 { color: var(--accent-rose); margin-bottom: 10px; font-size: 1rem; }
        .exception-box p, .exception-box li { color: var(--text-secondary); }

        .tip-box { background: rgba(34, 197, 94, 0.08); border-color: var(--accent-green); border: 1px solid rgba(34, 197, 94, 0.2); border-left: 4px solid var(--accent-green); }
        .tip-box h4 { color: var(--accent-green); margin-bottom: 10px; font-size: 1rem; }
        .tip-box p, .tip-box li { color: var(--text-secondary); }

        .info-box { background: rgba(59, 130, 246, 0.08); border-color: var(--accent-blue); border: 1px solid rgba(59, 130, 246, 0.2); border-left: 4px solid var(--accent-blue); }
        .info-box h4 { color: var(--accent-blue); margin-bottom: 10px; font-size: 1rem; }
        .info-box p, .info-box li { color: var(--text-secondary); }

        /* Decision Tree */
        .decision-tree {
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 22px;
            margin: 22px 0;
        }

        .decision-tree h3 { color: var(--accent-blue); margin-bottom: 18px; padding-bottom: 12px; border-bottom: 1px solid var(--border-subtle); font-size: 1.1rem; }

        .tree-node { margin-left: 20px; padding: 12px; border-left: 2px solid var(--accent-teal); position: relative; color: var(--text-secondary); }
        .tree-node::before { content: ''; position: absolute; left: -2px; top: 22px; width: 15px; height: 2px; background: var(--accent-teal); }
        .tree-node.level-1 { margin-left: 0; border-left: none; }
        .tree-node.level-1::before { display: none; }

        .tree-label { background: var(--accent-amber); color: var(--bg-primary); padding: 6px 14px; border-radius: 6px; font-weight: 700; display: inline-block; margin-bottom: 6px; font-size: 0.9rem; }

        /* Summary Grid */
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 18px; margin: 22px 0; }

        .summary-card { background: rgba(0,0,0,0.3); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 22px; text-align: center; }
        .summary-card h4 { color: var(--text-secondary); margin-bottom: 12px; font-size: 0.9rem; }
        .summary-card .value {
            font-size: 2.2rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-teal) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .summary-card .label { font-size: 0.85rem; color: var(--text-muted); margin-top: 8px; }

        /* Entity Cards */
        .entity-comparison { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin: 22px 0; }

        .entity-card { background: rgba(0,0,0,0.2); border: 1px solid var(--border-subtle); border-radius: 12px; overflow: hidden; }
        .entity-card-header { background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-teal) 100%); color: white; padding: 18px; text-align: center; }
        .entity-card-header h4 { font-size: 1.05rem; }
        .entity-card-body { padding: 22px; }
        .entity-card ul { list-style: none; padding: 0; }
        .entity-card li { padding: 10px 0; border-bottom: 1px solid var(--border-subtle); display: flex; align-items: center; gap: 12px; color: var(--text-secondary); font-size: 0.95rem; }
        .entity-card li:last-child { border-bottom: none; }
        .check-icon { color: var(--accent-green); font-weight: bold; }
        .x-icon { color: var(--accent-rose); font-weight: bold; }

        /* Quick Reference */
        .quick-ref {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
            border: 1px solid var(--border-subtle);
            padding: 28px;
            border-radius: 16px;
            margin-top: 30px;
            font-family: 'JetBrains Mono', monospace;
            scroll-margin-top: 75px;
        }

        .quick-ref h3 { color: var(--accent-amber); margin-bottom: 18px; font-family: 'Plus Jakarta Sans', sans-serif; }
        .quick-ref pre { background: rgba(0,0,0,0.4); border: 1px solid var(--border-subtle); padding: 20px; border-radius: 10px; overflow-x: auto; font-size: 0.85rem; line-height: 1.7; color: var(--text-secondary); }

        /* Step Lists */
        .step-list { margin: 20px 0; }
        .step-item { display: flex; gap: 15px; margin-bottom: 18px; padding: 18px; background: rgba(0,0,0,0.2); border-radius: 10px; border: 1px solid var(--border-subtle); }
        .step-number { background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-teal) 100%); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0; }
        .step-content h4 { color: var(--text-primary); margin-bottom: 6px; font-size: 1rem; }
        .step-content p { color: var(--text-secondary); font-size: 0.95rem; line-height: 1.6; }

        /* ====== AGENT OPPORTUNITIES STYLES ====== */
        .agent-header {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            padding: 35px;
            border-radius: 16px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .agent-header::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(139, 92, 246, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(245, 158, 11, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .agent-header h1 {
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 10px;
            position: relative;
            background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-amber) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .agent-header .subtitle { color: var(--text-secondary); font-size: 1.1rem; position: relative; }

        /* Heat Map */
        .heat-map-container { margin-bottom: 35px; }
        .heat-map-title { font-size: 1.3rem; font-weight: 700; color: var(--text-primary); margin-bottom: 20px; display: flex; align-items: center; gap: 12px; }

        .heat-map-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .heat-item {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 20px;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .heat-item:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .heat-item:active { transform: scale(0.98); }

        .heat-item::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 4px;
        }

        .heat-item.critical::before { background: linear-gradient(90deg, #ef4444, #f97316); }
        .heat-item.high::before { background: linear-gradient(90deg, #f97316, #eab308); }
        .heat-item.medium::before { background: linear-gradient(90deg, #eab308, #22c55e); }
        .heat-item.low::before { background: linear-gradient(90deg, #22c55e, #14b8a6); }

        .heat-item h4 { color: var(--text-primary); font-size: 0.95rem; margin-bottom: 8px; }
        .heat-item p { color: var(--text-muted); font-size: 0.8rem; }
        .heat-score { position: absolute; top: 15px; right: 15px; font-size: 1.4rem; font-weight: 800; }
        .heat-item.critical .heat-score { color: #ef4444; }
        .heat-item.high .heat-score { color: #f97316; }
        .heat-item.medium .heat-score { color: #eab308; }
        .heat-item.low .heat-score { color: #22c55e; }

        /* Agent Cards */
        .agent-cards { display: flex; flex-direction: column; gap: 25px; margin-top: 30px; }

        .agent-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            overflow: hidden;
            transition: box-shadow 0.3s;
            scroll-margin-top: 75px;
        }

        .agent-card:hover { box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .agent-card.highlight { box-shadow: 0 0 0 2px var(--accent-purple), 0 10px 40px rgba(139, 92, 246, 0.3); }

        .agent-card-header {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(139, 92, 246, 0.15) 100%);
            padding: 22px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-subtle);
        }

        .agent-card-title { display: flex; align-items: center; gap: 15px; }
        .agent-icon { font-size: 1.8rem; }
        .agent-card-title h3 { font-size: 1.2rem; font-weight: 700; color: var(--text-primary); }
        .agent-card-title span { font-size: 0.85rem; color: var(--text-muted); display: block; margin-top: 3px; }

        .agent-meta { display: flex; gap: 12px; align-items: center; }
        .confidence-badge { background: rgba(139, 92, 246, 0.15); color: var(--accent-purple); padding: 8px 16px; border-radius: 20px; font-weight: 700; font-size: 0.9rem; }
        .priority-badge { padding: 6px 14px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .priority-badge.critical { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
        .priority-badge.high { background: rgba(249, 115, 22, 0.15); color: #f97316; }
        .priority-badge.medium { background: rgba(234, 179, 8, 0.15); color: #eab308; }

        .agent-card-body { padding: 25px; }
        .agent-description { color: var(--text-secondary); line-height: 1.7; margin-bottom: 20px; }

        .agent-flow {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .agent-flow h4 { color: var(--accent-purple); margin-bottom: 15px; font-size: 0.95rem; }

        .agent-card-footer {
            background: rgba(0,0,0,0.2);
            padding: 18px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid var(--border-subtle);
        }

        .agent-tags { display: flex; gap: 8px; flex-wrap: wrap; }
        .agent-tag { background: rgba(255,255,255,0.05); color: var(--text-muted); padding: 5px 12px; border-radius: 15px; font-size: 0.75rem; }

        .prompt-btn {
            background: linear-gradient(135deg, var(--accent-purple) 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-size: 0.9rem;
        }

        .prompt-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4); }

        /* Summary Stats */
        .agent-summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-amber) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card .stat-label { color: var(--text-muted); font-size: 0.85rem; margin-top: 5px; }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.show { display: flex; }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            max-width: 900px;
            width: 100%;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(139, 92, 246, 0.1) 100%);
            padding: 25px 30px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 { font-size: 1.4rem; color: var(--text-primary); }

        .modal-close {
            background: rgba(255,255,255,0.1);
            border: none;
            color: var(--text-secondary);
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.5rem;
            transition: all 0.2s;
        }

        .modal-close:hover { background: rgba(244, 63, 94, 0.2); color: var(--accent-rose); }

        .modal-body { padding: 30px; overflow-y: auto; flex: 1; }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid var(--border-subtle);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .modal-btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-size: 0.95rem;
        }

        .modal-btn.primary { background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-teal) 100%); color: white; }
        .modal-btn.primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3); }
        .modal-btn.secondary { background: rgba(255,255,255,0.1); color: var(--text-secondary); }
        .modal-btn.secondary:hover { background: rgba(255,255,255,0.15); }

        /* Prompt Modal Specific */
        .prompt-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
        .prompt-tag { background: rgba(139, 92, 246, 0.15); color: var(--accent-purple); padding: 6px 14px; border-radius: 15px; font-size: 0.8rem; font-weight: 600; }

        .prompt-section { margin-bottom: 25px; }
        .prompt-section h4 { color: var(--accent-blue); margin-bottom: 12px; font-size: 1rem; }
        .prompt-box { background: rgba(0,0,0,0.4); border: 1px solid var(--border-subtle); border-radius: 10px; padding: 20px; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; line-height: 1.7; color: var(--text-secondary); white-space: pre-wrap; }

        .copy-success {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent-green);
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 600;
            display: none;
            z-index: 3000;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar { width: 240px; }
            .main-content { margin-left: 240px; padding: 80px 25px 25px 25px; }
        }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; padding: 70px 15px 15px 15px; }
            .breadcrumb { padding: 12px 15px; font-size: 0.85rem; }
        }
        .breadcrumb-logo-link { display: inline-flex; align-items: center; padding: 4px 8px; background: rgba(255,255,255,0.08); border-radius: 8px; border: 1px solid rgba(255,255,255,0.12); transition: all 0.2s; flex-shrink: 0; margin-right: 4px; }
        .breadcrumb-logo-link:hover { background: rgba(255,255,255,0.15); }
        .breadcrumb-logo { height: 24px; width: auto; display: block; }
    </style>
</head>
<body>
    <!-- Breadcrumb -->
    <nav class="breadcrumb">
<a href="../../index.html" class="breadcrumb-logo-link"><img src="../../images/clear-ai-logo.png" alt="Clear AI" class="breadcrumb-logo"></a>
        <a href="../../index.html">Home</a>
        <span class="separator">></span>
        <a href="../index.html">Mortgage Fundamentals</a>
        <span class="separator">></span>
        <span class="current">Self-Employed Workbook</span>
    </nav>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>Self-Employed Workbook</h2>
            <p>Income Analysis Guide</p>
        </div>

        <div class="sidebar-tabs">
            <button class="sidebar-tab active" onclick="switchTab('workflow')">Workflow</button>
            <button class="sidebar-tab agent-tab" onclick="switchTab('agents')">AI Agents</button>
        </div>

        <nav class="sidebar-nav" id="workflow-nav">
            <a href="#intro" class="nav-item active">
                <span class="nav-number">0</span>
                <span class="nav-label">Introduction</span>
            </a>
            <a href="#module1" class="nav-item">
                <span class="nav-number">1</span>
                <span class="nav-label">Defining the Borrower</span>
            </a>
            <a href="#entity-types" class="nav-item">
                <span class="nav-number">2</span>
                <span class="nav-label">Business Entity Types</span>
            </a>
            <a href="#viability" class="nav-item">
                <span class="nav-number">3</span>
                <span class="nav-label">Viability & Capacity</span>
            </a>
            <a href="#module2" class="nav-item">
                <span class="nav-number">4</span>
                <span class="nav-label">IRS Form 1040</span>
            </a>
            <a href="#schedules" class="nav-item">
                <span class="nav-number">5</span>
                <span class="nav-label">Tax Schedules</span>
            </a>
            <a href="#module3" class="nav-item">
                <span class="nav-number">6</span>
                <span class="nav-label">Business Returns</span>
            </a>
            <a href="#k1-forms" class="nav-item">
                <span class="nav-number">7</span>
                <span class="nav-label">K-1 Forms</span>
            </a>
            <a href="#appendices" class="nav-item">
                <span class="nav-number">8</span>
                <span class="nav-label">Red Flags & Ratios</span>
            </a>
            <a href="#quick-ref" class="nav-item">
                <span class="nav-number">QR</span>
                <span class="nav-label">Quick Reference</span>
            </a>
        </nav>

        <nav class="sidebar-nav" id="agents-nav" style="display: none;">
            <a href="#agent-taxextract" class="nav-item" onclick="scrollToAgent('agent-taxextract')">
                <span class="nav-number">1</span>
                <span class="nav-label">Tax Data Extractor</span>
            </a>
            <a href="#agent-incomemath" class="nav-item" onclick="scrollToAgent('agent-incomemath')">
                <span class="nav-number">2</span>
                <span class="nav-label">Income Calculator</span>
            </a>
            <a href="#agent-entityid" class="nav-item" onclick="scrollToAgent('agent-entityid')">
                <span class="nav-number">3</span>
                <span class="nav-label">Entity Identifier</span>
            </a>
            <a href="#agent-redflag" class="nav-item" onclick="scrollToAgent('agent-redflag')">
                <span class="nav-number">4</span>
                <span class="nav-label">Red Flag Scanner</span>
            </a>
            <a href="#agent-form1084" class="nav-item" onclick="scrollToAgent('agent-form1084')">
                <span class="nav-number">5</span>
                <span class="nav-label">Form 1084 Generator</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <button class="doc-btn" onclick="openDocModal()">
                <span>View Full Documentation</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Workflow Panel -->
        <div id="workflow-panel" class="tab-panel active">
            <div class="header">
                <h1>Self-Employed Workbook</h1>
                <p class="subtitle">Comprehensive guide for analyzing income for self-employed borrowers</p>
                <div class="meta">
                    <span class="meta-item">Source: Radian Training</span>
                    <span class="meta-item">3 Modules</span>
                    <span class="meta-item">Form 1084 Focus</span>
                </div>
            </div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #22c55e, #16a34a);"></div>
                    <span>Start/End</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #3b82f6, #2563eb);"></div>
                    <span>Action</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #f59e0b, #d97706);"></div>
                    <span>Decision</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #14b8a6, #0d9488);"></div>
                    <span>Output</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #f43f5e, #dc2626);"></div>
                    <span>Exception</span>
                </div>
            </div>

            <!-- Section 0: Introduction -->
            <section id="intro" class="section">
                <div class="section-header">
                    <div class="section-number">0</div>
                    <div class="section-title">
                        <h2>Introduction</h2>
                        <span>Understanding self-employed income analysis</span>
                    </div>
                </div>
                <div class="section-content">
                    <div class="info-box">
                        <h4>Purpose of This Workbook</h4>
                        <p>This workbook provides a systematic approach to analyzing income for self-employed borrowers. It covers business entity types, tax form interpretation, and the Fannie Mae Form 1084 cash flow analysis.</p>
                    </div>

                    <div class="workflow-diagram">
                        <div class="flow-row">
                            <div class="flow-node start">Self-Employed Borrower</div>
                            <span class="flow-arrow">→</span>
                            <div class="flow-node action">Identify Business Entity</div>
                            <span class="flow-arrow">→</span>
                            <div class="flow-node action">Gather Tax Returns</div>
                        </div>
                        <div class="flow-row">
                            <span class="flow-arrow down">↓</span>
                        </div>
                        <div class="flow-row">
                            <div class="flow-node action">Analyze Personal 1040</div>
                            <span class="flow-arrow">→</span>
                            <div class="flow-node action">Analyze Business Returns</div>
                            <span class="flow-arrow">→</span>
                            <div class="flow-node output">Complete Form 1084</div>
                        </div>
                    </div>

                    <div class="tip-box">
                        <h4>Key Principle</h4>
                        <p>Self-employed income analysis requires understanding both the personal tax return (Form 1040) and the business tax returns. The type of business entity determines which forms and schedules are relevant.</p>
                    </div>
                </div>
            </section>

            <!-- Section 1: Defining the Borrower -->
            <section id="module1" class="section">
                <div class="section-header">
                    <div class="section-number">1</div>
                    <div class="section-title">
                        <h2>Defining the Borrower</h2>
                        <span>Module 1: Assessing Capacity</span>
                    </div>
                </div>
                <div class="section-content">
                    <div class="info-box">
                        <h4>Self-Employed Definition</h4>
                        <p>A borrower is considered self-employed when they have 25% or greater ownership interest in a business. This ownership threshold triggers the requirement for business income analysis using Form 1084.</p>
                    </div>

                    <div class="decision-tree">
                        <h3>Ownership Interest Decision Tree</h3>
                        <div class="tree-node level-1">
                            <span class="tree-label">Does borrower own 25% or more of a business?</span>
                        </div>
                        <div class="tree-node">
                            <strong>YES:</strong> Borrower is self-employed - analyze business income with Form 1084
                        </div>
                        <div class="tree-node">
                            <strong>NO:</strong> Borrower is W-2 employee - standard income documentation applies
                        </div>
                    </div>

                    <div class="summary-grid">
                        <div class="summary-card">
                            <h4>Ownership Threshold</h4>
                            <div class="value">25%</div>
                            <div class="label">Or greater ownership</div>
                        </div>
                        <div class="summary-card">
                            <h4>Years Required</h4>
                            <div class="value">2</div>
                            <div class="label">Years of tax returns</div>
                        </div>
                        <div class="summary-card">
                            <h4>Key Form</h4>
                            <div class="value">1084</div>
                            <div class="label">Cash Flow Analysis</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Section 2: Business Entity Types -->
            <section id="entity-types" class="section">
                <div class="section-header">
                    <div class="section-number">2</div>
                    <div class="section-title">
                        <h2>Business Entity Types</h2>
                        <span>Understanding different business structures</span>
                    </div>
                </div>
                <div class="section-content">
                    <div class="entity-comparison">
                        <div class="entity-card">
                            <div class="entity-card-header">
                                <h4>Sole Proprietor</h4>
                            </div>
                            <div class="entity-card-body">
                                <ul>
                                    <li><span class="check-icon">✓</span> Single owner, no legal separation</li>
                                    <li><span class="check-icon">✓</span> Reports on Schedule C</li>
                                    <li><span class="check-icon">✓</span> Pass-through taxation</li>
                                    <li><span class="check-icon">✓</span> Simplest structure</li>
                                </ul>
                            </div>
                        </div>
                        <div class="entity-card">
                            <div class="entity-card-header">
                                <h4>Partnership</h4>
                            </div>
                            <div class="entity-card-body">
                                <ul>
                                    <li><span class="check-icon">✓</span> Two or more owners</li>
                                    <li><span class="check-icon">✓</span> Files Form 1065</li>
                                    <li><span class="check-icon">✓</span> Issues K-1 to partners</li>
                                    <li><span class="check-icon">✓</span> Pass-through taxation</li>
                                </ul>
                            </div>
                        </div>
                        <div class="entity-card">
                            <div class="entity-card-header">
                                <h4>S Corporation</h4>
                            </div>
                            <div class="entity-card-body">
                                <ul>
                                    <li><span class="check-icon">✓</span> Limited liability</li>
                                    <li><span class="check-icon">✓</span> Files Form 1120S</li>
                                    <li><span class="check-icon">✓</span> Issues K-1 to shareholders</li>
                                    <li><span class="check-icon">✓</span> Pass-through taxation</li>
                                </ul>
                            </div>
                        </div>
                        <div class="entity-card">
                            <div class="entity-card-header">
                                <h4>C Corporation</h4>
                            </div>
                            <div class="entity-card-body">
                                <ul>
                                    <li><span class="check-icon">✓</span> Separate legal entity</li>
                                    <li><span class="check-icon">✓</span> Files Form 1120</li>
                                    <li><span class="x-icon">✗</span> Double taxation possible</li>
                                    <li><span class="check-icon">✓</span> No K-1 issued</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="info-box">
                        <h4>LLC Tax Treatment</h4>
                        <p>Limited Liability Companies (LLCs) are flexible and can elect to be taxed as a sole proprietorship, partnership, S-Corp, or C-Corp. Check the tax return to determine how the LLC is being taxed, as this determines which forms to analyze.</p>
                    </div>

                    <table class="field-table">
                        <thead>
                            <tr>
                                <th>Entity Type</th>
                                <th>Business Return</th>
                                <th>Personal Schedule</th>
                                <th>K-1 Issued?</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Sole Proprietor</td>
                                <td>None</td>
                                <td>Schedule C</td>
                                <td>No</td>
                            </tr>
                            <tr>
                                <td>Partnership</td>
                                <td>Form 1065</td>
                                <td>Schedule E</td>
                                <td>Yes (K-1 1065)</td>
                            </tr>
                            <tr>
                                <td>S Corporation</td>
                                <td>Form 1120S</td>
                                <td>Schedule E</td>
                                <td>Yes (K-1 1120S)</td>
                            </tr>
                            <tr>
                                <td>C Corporation</td>
                                <td>Form 1120</td>
                                <td>W-2 wages only</td>
                                <td>No</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Section 3: Viability & Capacity -->
            <section id="viability" class="section">
                <div class="section-header">
                    <div class="section-number">3</div>
                    <div class="section-title">
                        <h2>Viability & Capacity</h2>
                        <span>Assessing business stability and borrower ability</span>
                    </div>
                </div>
                <div class="section-content">
                    <div class="workflow-diagram">
                        <div class="flow-row">
                            <div class="flow-node action">Evaluate Business Viability</div>
                            <span class="flow-arrow">→</span>
                            <div class="flow-node decision">Business Stable?</div>
                        </div>
                        <div class="decision-branch">
                            <div class="branch">
                                <span class="branch-label">YES</span>
                                <div class="flow-node action">Calculate Cash Flow</div>
                            </div>
                            <div class="branch">
                                <span class="branch-label">NO</span>
                                <div class="flow-node exception">Decline or Reduce Income</div>
                            </div>
                        </div>
                    </div>

                    <div class="step-list">
                        <div class="step-item">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <h4>Business History</h4>
                                <p>Verify the business has been in operation for at least 2 years. Review tax returns for both years to establish consistent operations.</p>
                            </div>
                        </div>
                        <div class="step-item">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <h4>Income Trend Analysis</h4>
                                <p>Compare year-over-year income. Declining income may require averaging or using the lower year. Significant declines require explanation.</p>
                            </div>
                        </div>
                        <div class="step-item">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <h4>Liquidity Assessment</h4>
                                <p>Evaluate the business's ability to support itself and the borrower's income. Review current ratio and working capital.</p>
                            </div>
                        </div>
                    </div>

                    <div class="exception-box">
                        <h4>Red Flags for Viability</h4>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li>Declining income over multiple years</li>
                            <li>Negative business income</li>
                            <li>High debt-to-income ratios</li>
                            <li>Inconsistent revenue patterns</li>
                            <li>Recent business restructuring</li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Section 4: IRS Form 1040 -->
            <section id="module2" class="section">
                <div class="section-header">
                    <div class="section-number">4</div>
                    <div class="section-title">
                        <h2>IRS Form 1040 - Personal Tax Return</h2>
                        <span>Module 2: Understanding the personal return</span>
                    </div>
                </div>
                <div class="section-content">
                    <div class="info-box">
                        <h4>Form 1040 Overview</h4>
                        <p>The Form 1040 is the primary personal tax return. For self-employed borrowers, focus on the income sections that flow from business activities. Key lines include wages (W-2), business income (Schedule C), and supplemental income (Schedule E).</p>
                    </div>

                    <div class="workflow-diagram">
                        <div class="flow-row">
                            <div class="flow-node input">Form 1040</div>
                            <span class="flow-arrow">→</span>
                            <div class="flow-node action">Identify All Income Sources</div>
                            <span class="flow-arrow">→</span>
                            <div class="flow-node action">Locate Supporting Schedules</div>
                        </div>
                    </div>

                    <table class="field-table">
                        <thead>
                            <tr>
                                <th>1040 Line</th>
                                <th>Income Type</th>
                                <th>Supporting Schedule</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Line 1</td>
                                <td>Wages, Salaries, Tips</td>
                                <td>W-2</td>
                                <td><span class="badge required-badge">Required</span></td>
                            </tr>
                            <tr>
                                <td>Line 2</td>
                                <td>Interest Income</td>
                                <td>Schedule B</td>
                                <td><span class="badge optional-badge">If Applicable</span></td>
                            </tr>
                            <tr>
                                <td>Line 3</td>
                                <td>Dividend Income</td>
                                <td>Schedule B</td>
                                <td><span class="badge optional-badge">If Applicable</span></td>
                            </tr>
                            <tr>
                                <td>Line 7</td>
                                <td>Capital Gains/Losses</td>
                                <td>Schedule D</td>
                                <td><span class="badge calculated-badge">Calculated</span></td>
                            </tr>
                            <tr>
                                <td>Line 8</td>
                                <td>Business Income</td>
                                <td>Schedule C / Schedule 1</td>
                                <td><span class="badge required-badge">Required</span></td>
                            </tr>
                            <tr>
                                <td>Schedule 1, Line 5</td>
                                <td>Rental/Partnership/S-Corp</td>
                                <td>Schedule E</td>
                                <td><span class="badge required-badge">Required</span></td>
                            </tr>
                            <tr>
                                <td>Schedule 1, Line 6</td>
                                <td>Farm Income</td>
                                <td>Schedule F</td>
                                <td><span class="badge optional-badge">If Applicable</span></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="tip-box">
                        <h4>Documentation Tip</h4>
                        <p>Always obtain complete tax returns including all schedules and attachments. Missing schedules can result in incomplete income analysis and potential loan defects.</p>
                    </div>
                </div>
            </section>

            <!-- Section 5: Tax Schedules -->
            <section id="schedules" class="section">
                <div class="section-header">
                    <div class="section-number">5</div>
                    <div class="section-title">
                        <h2>Tax Schedules Deep Dive</h2>
                        <span>Schedule B, C, D, E, and F analysis</span>
                    </div>
                </div>
                <div class="section-content">
                    <div class="entity-comparison">
                        <div class="entity-card">
                            <div class="entity-card-header">
                                <h4>Schedule B - Interest & Dividends</h4>
                            </div>
                            <div class="entity-card-body">
                                <ul>
                                    <li><span class="check-icon">✓</span> Reports interest income over $1,500</li>
                                    <li><span class="check-icon">✓</span> Lists dividend sources</li>
                                    <li><span class="check-icon">✓</span> Generally NOT used for qualifying</li>
                                    <li><span class="check-icon">✓</span> Review for asset verification</li>
                                </ul>
                            </div>
                        </div>
                        <div class="entity-card">
                            <div class="entity-card-header">
                                <h4>Schedule C - Business Income</h4>
                            </div>
                            <div class="entity-card-body">
                                <ul>
                                    <li><span class="check-icon">✓</span> Sole proprietor/single-member LLC</li>
                                    <li><span class="check-icon">✓</span> Reports gross receipts</li>
                                    <li><span class="check-icon">✓</span> Lists business expenses</li>
                                    <li><span class="check-icon">✓</span> Net profit flows to Form 1040</li>
                                </ul>
                            </div>
                        </div>
                        <div class="entity-card">
                            <div class="entity-card-header">
                                <h4>Schedule D - Capital Gains</h4>
                            </div>
                            <div class="entity-card-body">
                                <ul>
                                    <li><span class="check-icon">✓</span> Short-term and long-term gains</li>
                                    <li><span class="x-icon">✗</span> Generally NOT used for qualifying</li>
                                    <li><span class="check-icon">✓</span> One-time gains are excluded</li>
                                    <li><span class="check-icon">✓</span> May indicate asset liquidation</li>
                                </ul>
                            </div>
                        </div>
                        <div class="entity-card">
                            <div class="entity-card-header">
                                <h4>Schedule E - Supplemental Income</h4>
                            </div>
                            <div class="entity-card-body">
                                <ul>
                                    <li><span class="check-icon">✓</span> Rental property income</li>
                                    <li><span class="check-icon">✓</span> Partnership income (K-1)</li>
                                    <li><span class="check-icon">✓</span> S-Corp income (K-1)</li>
                                    <li><span class="check-icon">✓</span> Estate/Trust income</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="decision-tree">
                        <h3>Schedule C Analysis</h3>
                        <div class="tree-node level-1">
                            <span class="tree-label">Line 7: Gross Income</span>
                        </div>
                        <div class="tree-node">
                            <strong>Less:</strong> Cost of Goods Sold (Line 4)
                        </div>
                        <div class="tree-node">
                            <strong>Less:</strong> Total Expenses (Line 28)
                        </div>
                        <div class="tree-node">
                            <strong>Equals:</strong> Net Profit/Loss (Line 31) - flows to Form 1040
                        </div>
                        <div class="tree-node">
                            <strong>Add Back:</strong> Depreciation (Line 13) and other non-cash expenses
                        </div>
                    </div>

                    <div class="info-box">
                        <h4>Schedule F - Farm Income</h4>
                        <p>Schedule F reports income and expenses from farming operations. Analysis is similar to Schedule C. Pay special attention to crop insurance proceeds, commodity credit loans, and agricultural program payments.</p>
                    </div>
                </div>
            </section>

            <!-- Section 6: Business Returns -->
            <section id="module3" class="section">
                <div class="section-header">
                    <div class="section-number">6</div>
                    <div class="section-title">
                        <h2>Business Tax Returns</h2>
                        <span>Module 3: Forms 1065, 1120S, and 1120</span>
                    </div>
                </div>
                <div class="section-content">
                    <div class="workflow-diagram">
                        <div class="flow-row">
                            <div class="flow-node decision">Entity Type?</div>
                        </div>
                        <div class="decision-branch">
                            <div class="branch">
                                <span class="branch-label">Partnership</span>
                                <div class="flow-node action">Form 1065</div>
                            </div>
                            <div class="branch">
                                <span class="branch-label">S-Corp</span>
                                <div class="flow-node action">Form 1120S</div>
                            </div>
                            <div class="branch">
                                <span class="branch-label">C-Corp</span>
                                <div class="flow-node action">Form 1120</div>
                            </div>
                        </div>
                    </div>

                    <table class="field-table">
                        <thead>
                            <tr>
                                <th>Form</th>
                                <th>Entity Type</th>
                                <th>Key Lines</th>
                                <th>Depreciation Line</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Form 1065</td>
                                <td>Partnership</td>
                                <td>Line 1-8 (Income), Line 9-20 (Deductions)</td>
                                <td>Line 16a</td>
                            </tr>
                            <tr>
                                <td>Form 1120S</td>
                                <td>S Corporation</td>
                                <td>Line 1-6 (Income), Line 7-19 (Deductions)</td>
                                <td>Line 14</td>
                            </tr>
                            <tr>
                                <td>Form 1120</td>
                                <td>C Corporation</td>
                                <td>Line 1-11 (Income), Line 12-29 (Deductions)</td>
                                <td>Line 20</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="tip-box">
                        <h4>Business Return Analysis</h4>
                        <p>For partnerships and S-Corps, the borrower's share of income is reported on their K-1 and flows to Schedule E of their personal return. For C-Corps, only W-2 wages and dividends can be used for qualifying income.</p>
                    </div>

                    <div class="step-list">
                        <div class="step-item">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <h4>Obtain Business Returns</h4>
                                <p>Request complete business tax returns for the same years as the personal returns. Ensure all schedules are included.</p>
                            </div>
                        </div>
                        <div class="step-item">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <h4>Verify Ownership Percentage</h4>
                                <p>Confirm borrower's ownership percentage matches what's reported on the K-1 (if applicable) and application.</p>
                            </div>
                        </div>
                        <div class="step-item">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <h4>Calculate Borrower's Share</h4>
                                <p>For add-backs (depreciation, etc.), calculate the borrower's proportionate share based on ownership percentage.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Section 7: K-1 Forms -->
            <section id="k1-forms" class="section">
                <div class="section-header">
                    <div class="section-number">7</div>
                    <div class="section-title">
                        <h2>K-1 Forms</h2>
                        <span>Partnership and S-Corp pass-through income</span>
                    </div>
                </div>
                <div class="section-content">
                    <div class="info-box">
                        <h4>What is a K-1?</h4>
                        <p>Schedule K-1 reports each partner's or shareholder's share of the business's income, deductions, and credits. The amounts on the K-1 flow to the individual's personal tax return (Schedule E).</p>
                    </div>

                    <div class="entity-comparison">
                        <div class="entity-card">
                            <div class="entity-card-header">
                                <h4>K-1 from Form 1065 (Partnership)</h4>
                            </div>
                            <div class="entity-card-body">
                                <ul>
                                    <li><span class="check-icon">✓</span> Part I: Partnership info</li>
                                    <li><span class="check-icon">✓</span> Part II: Partner info & ownership %</li>
                                    <li><span class="check-icon">✓</span> Part III: Partner's share of income</li>
                                    <li><span class="check-icon">✓</span> Box 1: Ordinary business income</li>
                                    <li><span class="check-icon">✓</span> Box 4: Guaranteed payments</li>
                                </ul>
                            </div>
                        </div>
                        <div class="entity-card">
                            <div class="entity-card-header">
                                <h4>K-1 from Form 1120S (S-Corp)</h4>
                            </div>
                            <div class="entity-card-body">
                                <ul>
                                    <li><span class="check-icon">✓</span> Part I: Corporation info</li>
                                    <li><span class="check-icon">✓</span> Part II: Shareholder info & ownership %</li>
                                    <li><span class="check-icon">✓</span> Part III: Shareholder's share of income</li>
                                    <li><span class="check-icon">✓</span> Box 1: Ordinary business income</li>
                                    <li><span class="check-icon">✓</span> No guaranteed payments (W-2 instead)</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="exception-box">
                        <h4>K-1 Matching Requirement</h4>
                        <p>The K-1 amounts MUST match what's reported on Schedule E of the personal return. Discrepancies require explanation and may indicate amended returns or errors.</p>
                    </div>

                    <table class="field-table">
                        <thead>
                            <tr>
                                <th>K-1 Box</th>
                                <th>Description</th>
                                <th>Use in Qualifying</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Box 1</td>
                                <td>Ordinary Business Income/Loss</td>
                                <td><span class="badge required-badge">Primary Income</span></td>
                            </tr>
                            <tr>
                                <td>Box 2</td>
                                <td>Net Rental Real Estate Income</td>
                                <td><span class="badge calculated-badge">Add to Schedule E</span></td>
                            </tr>
                            <tr>
                                <td>Box 4 (1065)</td>
                                <td>Guaranteed Payments</td>
                                <td><span class="badge required-badge">Include in Income</span></td>
                            </tr>
                            <tr>
                                <td>Box 5</td>
                                <td>Interest Income</td>
                                <td><span class="badge optional-badge">Generally Excluded</span></td>
                            </tr>
                            <tr>
                                <td>Box 6</td>
                                <td>Dividends</td>
                                <td><span class="badge optional-badge">Generally Excluded</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Section 8: Red Flags & Ratios -->
            <section id="appendices" class="section">
                <div class="section-header">
                    <div class="section-number">8</div>
                    <div class="section-title">
                        <h2>Red Flags & Financial Ratios</h2>
                        <span>Appendices: Warning signs and analysis tools</span>
                    </div>
                </div>
                <div class="section-content">
                    <div class="exception-box">
                        <h4>Common Red Flags in Self-Employed Files</h4>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li><strong>Declining Income:</strong> Year-over-year decrease greater than 20%</li>
                            <li><strong>Negative Net Income:</strong> Business showing losses</li>
                            <li><strong>High Write-offs:</strong> Expenses exceeding industry norms</li>
                            <li><strong>Mismatched Documents:</strong> K-1 not matching Schedule E</li>
                            <li><strong>Recent Business Start:</strong> Less than 2 years in operation</li>
                            <li><strong>Large Cash Deposits:</strong> Unreported or unexplained income</li>
                            <li><strong>Multiple Business Interests:</strong> Complex ownership structures</li>
                            <li><strong>Excessive Distributions:</strong> Distributions exceeding net income</li>
                        </ul>
                    </div>

                    <div class="decision-tree">
                        <h3>Liquidity Ratio Analysis</h3>
                        <div class="tree-node level-1">
                            <span class="tree-label">Current Ratio = Current Assets / Current Liabilities</span>
                        </div>
                        <div class="tree-node">
                            <strong>Ratio > 1.0:</strong> Business can meet short-term obligations
                        </div>
                        <div class="tree-node">
                            <strong>Ratio < 1.0:</strong> Potential liquidity issues - requires explanation
                        </div>
                    </div>

                    <div class="info-box">
                        <h4>Comparative Income Analysis</h4>
                        <p>When income trends are inconsistent, compare:</p>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li>Year-over-year gross receipts</li>
                            <li>Year-over-year net income</li>
                            <li>Expense ratios (expenses as % of revenue)</li>
                            <li>Distribution patterns vs. income</li>
                        </ul>
                    </div>

                    <div class="tip-box">
                        <h4>Income Trending Decision</h4>
                        <p><strong>Stable/Increasing:</strong> Average the two years<br>
                        <strong>Declining:</strong> Use the lower (most recent) year OR average if decline is less than 20% and explained<br>
                        <strong>Significant Decline (>20%):</strong> Use lower year; may require additional documentation</p>
                    </div>
                </div>
            </section>

            <!-- Quick Reference -->
            <section id="quick-ref" class="quick-ref">
                <h3>Quick Reference: Form 1084 Cash Flow Analysis</h3>
                <pre>
FORM 1084 - SELF-EMPLOYED INCOME CALCULATION
============================================

STEP 1: Identify Business Type
------------------------------
[ ] Sole Proprietor → Schedule C
[ ] Partnership → Form 1065 + K-1
[ ] S Corporation → Form 1120S + K-1
[ ] C Corporation → Form 1120 (W-2 income only)

STEP 2: Calculate Adjusted Business Income
------------------------------------------
Start with: Net Profit/Ordinary Income
   + Depreciation (non-cash expense)
   + Depletion
   + Amortization
   + Meals & Entertainment (50% add-back)
   + Business Use of Home
   - Mortgage Interest (if claiming home)
   = Adjusted Business Income

STEP 3: Apply Ownership Percentage
----------------------------------
For partnerships/S-Corps:
Adjusted Business Income × Ownership % = Borrower's Share

STEP 4: Trending Analysis
-------------------------
Year 1 Income: $_______
Year 2 Income: $_______
Trend: [ ] Stable [ ] Increasing [ ] Declining

If Declining > 20%: Use lower year
If Stable/Increasing: Average both years

STEP 5: Final Monthly Income
----------------------------
Annual Qualifying Income ÷ 12 = Monthly Income

KEY DOCUMENTS REQUIRED
======================
[ ] 2 years personal tax returns (1040)
[ ] 2 years business tax returns
[ ] All K-1s
[ ] All Schedules (B, C, D, E, F)
[ ] Year-to-date P&L (if applicable)
[ ] Business license verification

COMMON ADD-BACKS BY FORM
========================
Schedule C: Line 13 (Depreciation)
Form 1065: Line 16a (Depreciation)
Form 1120S: Line 14 (Depreciation)
Form 1120: Line 20 (Depreciation)
                </pre>
            </section>
        </div>

        <!-- Agents Panel -->
        <div id="agents-panel" class="tab-panel">
            <div class="agent-header">
                <h1>AI Agent Opportunities</h1>
                <p class="subtitle">Automation potential for self-employed income analysis</p>
            </div>

            <div class="agent-summary-stats">
                <div class="stat-card">
                    <div class="stat-value">5</div>
                    <div class="stat-label">Agent Opportunities</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">85%</div>
                    <div class="stat-label">Avg Confidence</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">4.2hrs</div>
                    <div class="stat-label">Est. Time Saved</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">2</div>
                    <div class="stat-label">Critical Priority</div>
                </div>
            </div>

            <div class="heat-map-container">
                <h3 class="heat-map-title">Automation Priority Heat Map</h3>
                <div class="heat-map-grid">
                    <div class="heat-item critical" onclick="scrollToAgent('agent-taxextract')">
                        <span class="heat-score">95</span>
                        <h4>Tax Data Extraction</h4>
                        <p>OCR and data extraction from tax returns</p>
                    </div>
                    <div class="heat-item critical" onclick="scrollToAgent('agent-incomemath')">
                        <span class="heat-score">92</span>
                        <h4>Income Calculation</h4>
                        <p>Form 1084 automated calculation</p>
                    </div>
                    <div class="heat-item high" onclick="scrollToAgent('agent-entityid')">
                        <span class="heat-score">85</span>
                        <h4>Entity Identification</h4>
                        <p>Auto-detect business structure</p>
                    </div>
                    <div class="heat-item high" onclick="scrollToAgent('agent-redflag')">
                        <span class="heat-score">80</span>
                        <h4>Red Flag Detection</h4>
                        <p>Anomaly and risk identification</p>
                    </div>
                    <div class="heat-item medium" onclick="scrollToAgent('agent-form1084')">
                        <span class="heat-score">75</span>
                        <h4>Form 1084 Generation</h4>
                        <p>Auto-populate and generate form</p>
                    </div>
                </div>
            </div>

            <div class="agent-cards">
                <!-- Agent 1: Tax Data Extractor -->
                <div class="agent-card" id="agent-taxextract">
                    <div class="agent-card-header">
                        <div class="agent-card-title">
                            <span class="agent-icon">📄</span>
                            <div>
                                <h3>Tax Data Extractor Agent</h3>
                                <span>Document Processing / OCR</span>
                            </div>
                        </div>
                        <div class="agent-meta">
                            <span class="confidence-badge">95% Confidence</span>
                            <span class="priority-badge critical">Critical</span>
                        </div>
                    </div>
                    <div class="agent-card-body">
                        <p class="agent-description">
                            This agent uses OCR and intelligent document processing to extract key data points from tax returns (1040, 1065, 1120S, 1120). It identifies line items, validates data accuracy, and pre-populates income analysis worksheets, reducing manual data entry by 90%.
                        </p>
                        <div class="agent-flow">
                            <h4>Agent Workflow</h4>
                            <div class="flow-row">
                                <div class="flow-node input">Tax Return PDF</div>
                                <span class="flow-arrow">→</span>
                                <div class="flow-node action">OCR Processing</div>
                                <span class="flow-arrow">→</span>
                                <div class="flow-node action">Field Extraction</div>
                                <span class="flow-arrow">→</span>
                                <div class="flow-node output">Structured Data</div>
                            </div>
                        </div>
                    </div>
                    <div class="agent-card-footer">
                        <div class="agent-tags">
                            <span class="agent-tag">OCR</span>
                            <span class="agent-tag">Document AI</span>
                            <span class="agent-tag">Data Extraction</span>
                            <span class="agent-tag">High ROI</span>
                        </div>
                        <button class="prompt-btn" onclick="showAgentPrompt('taxextract')">View Build Prompt</button>
                    </div>
                </div>

                <!-- Agent 2: Income Calculator -->
                <div class="agent-card" id="agent-incomemath">
                    <div class="agent-card-header">
                        <div class="agent-card-title">
                            <span class="agent-icon">🔢</span>
                            <div>
                                <h3>Income Calculator Agent</h3>
                                <span>Mathematical Processing</span>
                            </div>
                        </div>
                        <div class="agent-meta">
                            <span class="confidence-badge">92% Confidence</span>
                            <span class="priority-badge critical">Critical</span>
                        </div>
                    </div>
                    <div class="agent-card-body">
                        <p class="agent-description">
                            This agent automates the Form 1084 cash flow analysis by applying the correct add-backs, ownership percentages, and trending calculations. It handles all entity types and produces audit-ready income calculations with full documentation of the methodology used.
                        </p>
                        <div class="agent-flow">
                            <h4>Agent Workflow</h4>
                            <div class="flow-row">
                                <div class="flow-node input">Extracted Tax Data</div>
                                <span class="flow-arrow">→</span>
                                <div class="flow-node action">Apply Add-backs</div>
                                <span class="flow-arrow">→</span>
                                <div class="flow-node action">Calculate Ownership Share</div>
                                <span class="flow-arrow">→</span>
                                <div class="flow-node output">Monthly Income</div>
                            </div>
                        </div>
                    </div>
                    <div class="agent-card-footer">
                        <div class="agent-tags">
                            <span class="agent-tag">Form 1084</span>
                            <span class="agent-tag">Cash Flow</span>
                            <span class="agent-tag">Trending</span>
                            <span class="agent-tag">Audit Ready</span>
                        </div>
                        <button class="prompt-btn" onclick="showAgentPrompt('incomemath')">View Build Prompt</button>
                    </div>
                </div>

                <!-- Agent 3: Entity Identifier -->
                <div class="agent-card" id="agent-entityid">
                    <div class="agent-card-header">
                        <div class="agent-card-title">
                            <span class="agent-icon">🏢</span>
                            <div>
                                <h3>Entity Identifier Agent</h3>
                                <span>Classification / Rules Engine</span>
                            </div>
                        </div>
                        <div class="agent-meta">
                            <span class="confidence-badge">85% Confidence</span>
                            <span class="priority-badge high">High</span>
                        </div>
                    </div>
                    <div class="agent-card-body">
                        <p class="agent-description">
                            This agent automatically identifies the business entity type by analyzing the tax forms present, EIN patterns, and form structures. It determines whether a borrower is a sole proprietor, partner, S-Corp shareholder, or C-Corp owner and routes the file to the appropriate analysis workflow.
                        </p>
                        <div class="agent-flow">
                            <h4>Agent Workflow</h4>
                            <div class="flow-row">
                                <div class="flow-node input">Tax Documents</div>
                                <span class="flow-arrow">→</span>
                                <div class="flow-node action">Form Detection</div>
                                <span class="flow-arrow">→</span>
                                <div class="flow-node decision">Entity Type?</div>
                                <span class="flow-arrow">→</span>
                                <div class="flow-node output">Route to Workflow</div>
                            </div>
                        </div>
                    </div>
                    <div class="agent-card-footer">
                        <div class="agent-tags">
                            <span class="agent-tag">Classification</span>
                            <span class="agent-tag">Entity Detection</span>
                            <span class="agent-tag">Workflow Routing</span>
                        </div>
                        <button class="prompt-btn" onclick="showAgentPrompt('entityid')">View Build Prompt</button>
                    </div>
                </div>

                <!-- Agent 4: Red Flag Scanner -->
                <div class="agent-card" id="agent-redflag">
                    <div class="agent-card-header">
                        <div class="agent-card-title">
                            <span class="agent-icon">🚩</span>
                            <div>
                                <h3>Red Flag Scanner Agent</h3>
                                <span>Risk Assessment / Anomaly Detection</span>
                            </div>
                        </div>
                        <div class="agent-meta">
                            <span class="confidence-badge">80% Confidence</span>
                            <span class="priority-badge high">High</span>
                        </div>
                    </div>
                    <div class="agent-card-body">
                        <p class="agent-description">
                            This agent scans self-employed files for common red flags including declining income trends, K-1/Schedule E mismatches, excessive distributions, and liquidity concerns. It generates a risk assessment report with specific concerns and recommended follow-up actions.
                        </p>
                        <div class="agent-flow">
                            <h4>Agent Workflow</h4>
                            <div class="flow-row">
                                <div class="flow-node input">Income Data</div>
                                <span class="flow-arrow">→</span>
                                <div class="flow-node action">Pattern Analysis</div>
                                <span class="flow-arrow">→</span>
                                <div class="flow-node action">Compare to Benchmarks</div>
                                <span class="flow-arrow">→</span>
                                <div class="flow-node output">Risk Report</div>
                            </div>
                        </div>
                    </div>
                    <div class="agent-card-footer">
                        <div class="agent-tags">
                            <span class="agent-tag">Risk Assessment</span>
                            <span class="agent-tag">Anomaly Detection</span>
                            <span class="agent-tag">Compliance</span>
                        </div>
                        <button class="prompt-btn" onclick="showAgentPrompt('redflag')">View Build Prompt</button>
                    </div>
                </div>

                <!-- Agent 5: Form 1084 Generator -->
                <div class="agent-card" id="agent-form1084">
                    <div class="agent-card-header">
                        <div class="agent-card-title">
                            <span class="agent-icon">📝</span>
                            <div>
                                <h3>Form 1084 Generator Agent</h3>
                                <span>Document Generation</span>
                            </div>
                        </div>
                        <div class="agent-meta">
                            <span class="confidence-badge">75% Confidence</span>
                            <span class="priority-badge medium">Medium</span>
                        </div>
                    </div>
                    <div class="agent-card-body">
                        <p class="agent-description">
                            This agent takes the calculated income data and generates a completed Form 1084 (Fannie Mae Cash Flow Analysis). It populates all required fields, applies correct formatting, and produces a print-ready PDF that can be uploaded to the loan file.
                        </p>
                        <div class="agent-flow">
                            <h4>Agent Workflow</h4>
                            <div class="flow-row">
                                <div class="flow-node input">Calculated Income</div>
                                <span class="flow-arrow">→</span>
                                <div class="flow-node action">Map to Form Fields</div>
                                <span class="flow-arrow">→</span>
                                <div class="flow-node action">Generate PDF</div>
                                <span class="flow-arrow">→</span>
                                <div class="flow-node output">Form 1084 PDF</div>
                            </div>
                        </div>
                    </div>
                    <div class="agent-card-footer">
                        <div class="agent-tags">
                            <span class="agent-tag">PDF Generation</span>
                            <span class="agent-tag">Form 1084</span>
                            <span class="agent-tag">Document Output</span>
                        </div>
                        <button class="prompt-btn" onclick="showAgentPrompt('form1084')">View Build Prompt</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Documentation Modal -->
    <div class="modal-overlay" id="docModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Self-Employed Workbook - Full Documentation</h2>
                <button class="modal-close" onclick="closeDocModal()">×</button>
            </div>
            <div class="modal-body">
                <pre id="docContent">
SELF-EMPLOYED INCOME ANALYSIS WORKBOOK
=====================================
Source: Radian Training Materials

TABLE OF CONTENTS
-----------------
1. Introduction
2. Module 1: Defining the Borrower and Assessing Capacity
   - Sole Proprietor
   - Partnership
   - S Corporation
   - Corporation
   - LLC
   - Viability Assessment
   - Capacity Analysis
   - Fannie Mae Form 1084
3. Module 2: IRS Form 1040 Personal Tax Return
   - Schedule B (Interest and Dividends)
   - Schedule C (Business Income)
   - Schedule C-EZ (Net Profit)
   - Schedule D (Capital Gains)
   - Schedule E (Supplemental Income)
   - Schedule F (Farm Income)
4. Module 3: Business Tax Returns
   - K-1 from Form 1065 (Partnership)
   - Form 1065 Analysis
   - K-1 from Form 1120S (S Corporation)
   - Form 1120S Analysis
   - Form 1120 (C Corporation)
5. Appendices
   - Liquidity Ratio Calculation
   - Comparative Income Analysis
   - Red Flags Checklist
6. Glossary

KEY CONCEPTS
------------
- 25% ownership threshold for self-employment classification
- 2 years of tax returns required
- Form 1084 for cash flow analysis
- Add-backs: Depreciation, Amortization, Depletion
- Entity type determines required forms
- K-1 income flows to Schedule E
- Trending analysis for income stability

REQUIRED DOCUMENTATION
----------------------
✓ 2 years complete personal tax returns (all pages and schedules)
✓ 2 years complete business tax returns (if applicable)
✓ All K-1s matching the business returns
✓ Year-to-date P&L statement (if requested)
✓ Business license or registration verification
✓ CPA letter (if income calculation is complex)
                </pre>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeDocModal()">Close</button>
                <button class="modal-btn primary" onclick="copyToClipboard()">Copy to Clipboard</button>
            </div>
        </div>
    </div>

    <!-- Agent Prompt Modal -->
    <div class="modal-overlay" id="promptModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="promptModalTitle">Agent Build Prompt</h2>
                <button class="modal-close" onclick="closePromptModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="prompt-tags" id="promptTags"></div>
                <div class="prompt-section">
                    <h4>Purpose</h4>
                    <div class="prompt-box" id="promptPurpose"></div>
                </div>
                <div class="prompt-section">
                    <h4>Build Prompt</h4>
                    <div class="prompt-box" id="promptContent"></div>
                </div>
                <div class="prompt-section">
                    <h4>Integration Points</h4>
                    <div class="prompt-box" id="promptIntegration"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closePromptModal()">Close</button>
                <button class="modal-btn primary" onclick="copyPromptToClipboard()">Copy Full Prompt</button>
            </div>
        </div>
    </div>

    <div class="copy-success" id="copySuccess">Copied to clipboard!</div>

    <script>
        // Tab switching
        function switchTab(tab) {
            document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));

            if (tab === 'workflow') {
                document.querySelector('.sidebar-tab:not(.agent-tab)').classList.add('active');
                document.getElementById('workflow-panel').classList.add('active');
                document.getElementById('workflow-nav').style.display = 'block';
                document.getElementById('agents-nav').style.display = 'none';
            } else {
                document.querySelector('.sidebar-tab.agent-tab').classList.add('active');
                document.getElementById('agents-panel').classList.add('active');
                document.getElementById('workflow-nav').style.display = 'none';
                document.getElementById('agents-nav').style.display = 'block';
            }

            window.scrollTo(0, 0);
        }

        // Scroll spy with isScrolling flag and 1000ms timeout
        const sections = document.querySelectorAll('.section, .quick-ref');
        const navItems = document.querySelectorAll('#workflow-nav .nav-item');
        let isScrolling = false;
        let scrollTimeout;

        function updateActiveNav() {
            if (isScrolling) return;

            let current = '';
            sections.forEach(section => {
                const sectionTop = section.offsetTop - 100;
                if (window.scrollY >= sectionTop) current = section.getAttribute('id');
            });
            navItems.forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('href') === '#' + current) item.classList.add('active');
            });
        }

        // Handle nav click to temporarily disable scroll spy
        navItems.forEach(item => {
            item.addEventListener('click', function(e) {
                isScrolling = true;
                clearTimeout(scrollTimeout);

                // Remove active from all, add to clicked
                navItems.forEach(nav => nav.classList.remove('active'));
                this.classList.add('active');

                // Re-enable scroll spy after 1000ms
                scrollTimeout = setTimeout(() => {
                    isScrolling = false;
                }, 1000);
            });
        });

        window.addEventListener('scroll', updateActiveNav);

        // Modal
        function openDocModal() {
            document.getElementById('docModal').classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeDocModal() {
            document.getElementById('docModal').classList.remove('show');
            document.body.style.overflow = '';
        }

        async function copyToClipboard() {
            try {
                await navigator.clipboard.writeText(document.getElementById('docContent').textContent);
                const success = document.getElementById('copySuccess');
                success.style.display = 'block';
                setTimeout(() => { success.style.display = 'none'; }, 2000);
            } catch (e) { alert('Failed to copy.'); }
        }

        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { closeDocModal(); closePromptModal(); } });
        document.getElementById('docModal').addEventListener('click', (e) => { if (e.target.id === 'docModal') closeDocModal(); });

        document.addEventListener('DOMContentLoaded', () => { updateActiveNav(); });

        // Scroll to agent card and highlight
        function scrollToAgent(agentId) {
            const agentCard = document.getElementById(agentId);
            if (agentCard) {
                document.querySelectorAll('.agent-card.highlight').forEach(card => {
                    card.classList.remove('highlight');
                });

                agentCard.scrollIntoView({ behavior: 'smooth', block: 'center' });

                setTimeout(() => {
                    agentCard.classList.add('highlight');
                }, 300);

                setTimeout(() => {
                    agentCard.classList.remove('highlight');
                }, 2500);
            }
        }

        // Agent Prompt System
        const agentPrompts = {
            taxextract: {
                name: 'Tax Data Extractor Agent',
                tags: ['Document AI', 'OCR', 'High Complexity', 'Critical Priority'],
                purpose: `This agent uses OCR and intelligent document processing to extract key data points from tax returns (1040, 1065, 1120S, 1120). It identifies line items, validates data accuracy, and pre-populates income analysis worksheets, reducing manual data entry by 90%.`,
                prompt: `You are building a Document Processing Agent for self-employed income analysis.

AGENT NAME: Tax Data Extractor
TYPE: Document AI / OCR Processing

OBJECTIVE:
Extract structured data from tax return PDFs including Form 1040, Schedules B/C/D/E/F, Forms 1065, 1120S, and 1120.

INPUT DOCUMENTS:
- Form 1040 (Personal Tax Return)
- Schedule B (Interest/Dividends)
- Schedule C (Business Income)
- Schedule D (Capital Gains)
- Schedule E (Supplemental Income)
- Schedule F (Farm Income)
- Form 1065 (Partnership Return)
- Form 1120S (S-Corp Return)
- Form 1120 (C-Corp Return)
- Schedule K-1 (Partner/Shareholder)

EXTRACTION TARGETS:

Form 1040:
- Filing Status
- Tax Year
- Taxpayer Name & SSN
- Line 1: Wages
- Line 7: Capital Gains
- Schedule 1, Line 3: Business Income
- Schedule 1, Line 5: Rental/Partnership Income

Schedule C:
- Line 1: Gross Receipts
- Line 4: Cost of Goods Sold
- Line 7: Gross Income
- Line 13: Depreciation
- Line 28: Total Expenses
- Line 31: Net Profit/Loss

Schedule E Part II:
- Partnership/S-Corp Name
- EIN
- Passive vs Nonpassive Income
- K-1 Box References

K-1 (1065 & 1120S):
- Part I: Entity Information
- Part II: Partner/Shareholder Info
- Part II, Item J: Ownership %
- Box 1: Ordinary Income
- Box 4: Guaranteed Payments (1065)
- Box 14: Self-Employment Earnings

OUTPUT FORMAT:
{
  "tax_year": "2024",
  "form_type": "1040",
  "taxpayer": { "name": "", "ssn_last4": "" },
  "income": {
    "wages": 0,
    "schedule_c_net": 0,
    "schedule_e_income": 0,
    "k1_ordinary_income": 0,
    "guaranteed_payments": 0
  },
  "addbacks": {
    "depreciation": 0,
    "amortization": 0,
    "depletion": 0
  },
  "ownership_percentage": 0,
  "confidence_scores": {}
}

VALIDATION RULES:
- Cross-reference K-1 amounts with Schedule E
- Verify EIN format: XX-XXXXXXX
- Flag missing pages or schedules
- Validate year consistency across documents`,
                integration: `INTEGRATION POINTS:

1. OCR Engine
   - Azure Form Recognizer or AWS Textract
   - Pre-built tax form models
   - Custom model training for edge cases

2. Document Classification
   - Auto-detect form type from header
   - Route to appropriate extraction model
   - Handle multi-page documents

3. Data Validation
   - Cross-reference between forms
   - Flag discrepancies for review
   - Confidence scoring per field

4. Output Destination
   - Byte LOS income worksheet
   - Form 1084 pre-population
   - Audit trail documentation`
            },
            incomemath: {
                name: 'Income Calculator Agent',
                tags: ['Mathematical Processing', 'Form 1084', 'Critical Priority'],
                purpose: `This agent automates the Form 1084 cash flow analysis by applying the correct add-backs, ownership percentages, and trending calculations. It handles all entity types and produces audit-ready income calculations.`,
                prompt: `You are building an Income Calculation Agent for Form 1084 analysis.

AGENT NAME: Income Calculator
TYPE: Mathematical Processing / Rules Engine

OBJECTIVE:
Calculate qualifying self-employed income following Fannie Mae Form 1084 methodology for all business entity types.

CALCULATION METHODOLOGY BY ENTITY:

1. SOLE PROPRIETOR (Schedule C):
   Net Profit (Line 31)
   + Depreciation (Line 13)
   + Amortization/Casualty Loss
   + Business Use of Home
   = Adjusted Business Income

2. PARTNERSHIP (Form 1065 + K-1):
   K-1 Box 1: Ordinary Income
   + K-1 Box 4: Guaranteed Payments
   + (Depreciation × Ownership %)
   + (Amortization × Ownership %)
   = Adjusted Partnership Income

3. S CORPORATION (Form 1120S + K-1):
   W-2 Wages from S-Corp
   + K-1 Box 1: Ordinary Income
   + (Depreciation × Ownership %)
   + (Distributions Analysis if needed)
   = Adjusted S-Corp Income

4. C CORPORATION (Form 1120):
   W-2 Wages ONLY
   (No pass-through income available)
   Consider: Dividend income if 2-year history

TRENDING ANALYSIS:
Year 1 Income: $Y1
Year 2 Income: $Y2

IF (Y2 >= Y1) OR (decline < 20%):
   Monthly Income = (Y1 + Y2) / 24

IF (decline >= 20%):
   Monthly Income = Y2 / 12
   Flag for underwriter review

LIQUIDITY CHECK:
Current Ratio = Current Assets / Current Liabilities
IF ratio < 1.0:
   Flag liquidity concern
   Request explanation

OUTPUT:
{
  "entity_type": "partnership",
  "year1_income": 85000,
  "year2_income": 92000,
  "trend": "increasing",
  "add_backs": {
    "depreciation": 12000,
    "amortization": 0,
    "ownership_adjusted": 6000
  },
  "total_adjusted_income": 98000,
  "averaging_method": "2-year average",
  "monthly_qualifying_income": 8167,
  "calculation_notes": []
}`,
                integration: `INTEGRATION POINTS:

1. Input Data
   - Extracted tax data from OCR agent
   - Entity type from classification agent
   - Ownership percentage verification

2. Calculation Engine
   - Apply Fannie Mae 1084 rules
   - Handle edge cases (losses, declining income)
   - Support manual overrides with audit trail

3. Output
   - Populate Form 1084 worksheet
   - Generate calculation summary
   - Flag items for underwriter review

4. Audit Trail
   - Log all inputs and calculations
   - Document methodology used
   - Store for compliance review`
            },
            entityid: {
                name: 'Entity Identifier Agent',
                tags: ['Classification', 'Rules Engine', 'High Priority'],
                purpose: `This agent automatically identifies the business entity type by analyzing the tax forms present and routes the file to the appropriate analysis workflow.`,
                prompt: `You are building a Business Entity Classification Agent.

AGENT NAME: Entity Identifier
TYPE: Classification / Routing

OBJECTIVE:
Automatically determine business entity type from tax documents and route to appropriate income analysis workflow.

CLASSIFICATION RULES:

1. SOLE PROPRIETOR:
   - Schedule C present
   - No Form 1065, 1120S, or 1120
   - No K-1 received
   - Single owner business

2. PARTNERSHIP:
   - K-1 from Form 1065 present
   - Form 1065 business return
   - Schedule E Part II shows partnership income
   - Multiple owners possible

3. S CORPORATION:
   - K-1 from Form 1120S present
   - Form 1120S business return
   - Schedule E Part II shows S-Corp income
   - May have W-2 from same company

4. C CORPORATION:
   - Form 1120 business return
   - NO K-1 issued
   - W-2 wages only for income
   - Dividends reported separately

5. LLC DETERMINATION:
   - Check tax election
   - Single-member LLC → Sole Proprietor treatment
   - Multi-member LLC → Partnership or S-Corp
   - Look for Form 8832 (Entity Classification)

DETECTION LOGIC:
1. Scan document set for form types
2. Match forms to entity patterns
3. Verify ownership percentage
4. Confirm tax treatment

OUTPUT:
{
  "entity_type": "s_corporation",
  "forms_detected": ["1040", "Schedule E", "K-1 1120S", "1120S"],
  "ownership_percentage": 50,
  "tax_treatment": "pass-through",
  "workflow": "s_corp_analysis",
  "confidence": 0.95
}`,
                integration: `INTEGRATION POINTS:

1. Document Inventory
   - List all forms in file
   - Identify missing required forms
   - Request additional documents

2. Workflow Routing
   - Sole Prop → Schedule C analysis
   - Partnership → 1065 + K-1 analysis
   - S-Corp → 1120S + K-1 + W-2 analysis
   - C-Corp → 1120 + W-2 only

3. Ownership Verification
   - Extract from K-1 Part II
   - Compare to loan application
   - Flag discrepancies

4. Downstream Triggers
   - Initiate correct calculation agent
   - Set required documentation checklist
   - Alert processor to entity type`
            },
            redflag: {
                name: 'Red Flag Scanner Agent',
                tags: ['Risk Assessment', 'Anomaly Detection', 'High Priority'],
                purpose: `This agent scans self-employed files for common red flags including declining income trends, K-1/Schedule E mismatches, excessive distributions, and liquidity concerns.`,
                prompt: `You are building a Risk Assessment Agent for self-employed income files.

AGENT NAME: Red Flag Scanner
TYPE: Anomaly Detection / Risk Assessment

OBJECTIVE:
Identify potential issues in self-employed borrower files that require additional scrutiny or documentation.

RED FLAG CATEGORIES:

1. INCOME TRENDS:
   - Declining income > 20% year-over-year
   - Negative net income in either year
   - Significant variance between years (>50%)
   - Income inconsistent with industry norms

2. DOCUMENT MISMATCHES:
   - K-1 amounts don't match Schedule E
   - Tax year inconsistencies
   - Missing schedules or forms
   - Amended returns without explanation

3. BUSINESS VIABILITY:
   - Current ratio < 1.0
   - Negative retained earnings
   - Distributions exceed net income
   - High officer compensation vs. profit

4. OWNERSHIP CONCERNS:
   - Ownership % changed between years
   - Multiple business interests
   - Related party transactions
   - Recent ownership changes

5. EXPENSE ANOMALIES:
   - Depreciation > 25% of gross receipts
   - Travel/entertainment > 10% of revenue
   - Sudden expense increases
   - Home office > 25% of expenses

SEVERITY LEVELS:
- CRITICAL: Requires immediate attention
- HIGH: Needs explanation before approval
- MEDIUM: Document for file, monitor
- LOW: Note for awareness

OUTPUT:
{
  "file_risk_score": 72,
  "red_flags": [
    {
      "category": "income_trends",
      "issue": "Declining income 23% YoY",
      "severity": "HIGH",
      "year1": 95000,
      "year2": 73000,
      "recommendation": "Use lower year; obtain explanation letter"
    }
  ],
  "required_actions": [],
  "cleared_items": []
}`,
                integration: `INTEGRATION POINTS:

1. Data Sources
   - Extracted tax data
   - Calculated income figures
   - Industry benchmarks database

2. Alert System
   - Real-time notifications
   - Prioritized task queue
   - Escalation to supervisor

3. Documentation
   - Auto-generate condition list
   - Template explanation letters
   - Cure tracking

4. Reporting
   - Risk dashboard
   - Trend analysis
   - Compliance metrics`
            },
            form1084: {
                name: 'Form 1084 Generator Agent',
                tags: ['Document Generation', 'PDF Output', 'Medium Priority'],
                purpose: `This agent takes calculated income data and generates a completed Form 1084 (Fannie Mae Cash Flow Analysis) ready for the loan file.`,
                prompt: `You are building a Document Generation Agent for Form 1084.

AGENT NAME: Form 1084 Generator
TYPE: Document Generation / PDF Processing

OBJECTIVE:
Generate a completed Fannie Mae Form 1084 (Cash Flow Analysis) from calculated self-employed income data.

FORM 1084 SECTIONS:

SECTION 1: BORROWER INFO
- Borrower Name
- Loan Number
- Property Address
- Business Name
- Business Type

SECTION 2: SCHEDULE C ANALYSIS
- Gross Receipts/Sales
- Cost of Goods Sold
- Gross Profit
- Total Expenses
- Net Profit/Loss
- Add-back items

SECTION 3: PARTNERSHIP/S-CORP (K-1)
- Ordinary Income (Box 1)
- Guaranteed Payments (Box 4)
- Net Rental Income (Box 2)
- Ownership Percentage
- Proportionate Add-backs

SECTION 4: CORPORATION ANALYSIS
- Corporate Income
- Depreciation
- Depletion
- Amortization
- Officer Compensation

SECTION 5: INCOME CALCULATION
- Year 1 Total
- Year 2 Total
- Trending Analysis
- Monthly Qualifying Income

FIELD MAPPING:
{
  "borrower_name": → Section 1, Field 1
  "business_name": → Section 1, Field 4
  "schedule_c_net": → Section 2, Line 31
  "depreciation": → Section 2, Add-back Line
  "k1_ordinary": → Section 3, Line 1
  "ownership_pct": → Section 3, Line J
  "monthly_income": → Section 5, Final
}

PDF GENERATION:
- Use Fannie Mae official template
- Embed calculated values
- Add preparer signature block
- Include calculation date

OUTPUT:
- Completed Form 1084 PDF
- Calculation worksheet attachment
- Ready for Stored Docs upload`,
                integration: `INTEGRATION POINTS:

1. Input Data
   - Calculated income from math agent
   - Borrower info from loan application
   - Business details from tax returns

2. PDF Engine
   - PDF-lib for field population
   - Fannie Mae template repository
   - Version control for form updates

3. Output Handling
   - Save to Stored Docs
   - Set document type/category
   - Trigger QC review

4. Compliance
   - Preparer attestation
   - Date stamping
   - Audit trail logging`
            }
        };

        // Show agent prompt modal
        let currentPromptContent = '';

        function showAgentPrompt(agentKey) {
            const agent = agentPrompts[agentKey];
            if (!agent) return;

            document.getElementById('promptModalTitle').textContent = agent.name + ' - Build Prompt';

            const tagsHtml = agent.tags.map(tag => '<span class="prompt-tag">' + tag + '</span>').join('');
            document.getElementById('promptTags').innerHTML = tagsHtml;

            document.getElementById('promptPurpose').textContent = agent.purpose;
            document.getElementById('promptContent').textContent = agent.prompt;
            document.getElementById('promptIntegration').textContent = agent.integration;

            currentPromptContent = '# ' + agent.name + '\n\n## Purpose\n' + agent.purpose + '\n\n## Build Prompt\n' + agent.prompt + '\n\n## Integration Points\n' + agent.integration;

            document.getElementById('promptModal').classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closePromptModal() {
            document.getElementById('promptModal').classList.remove('show');
            document.body.style.overflow = '';
        }

        async function copyPromptToClipboard() {
            try {
                await navigator.clipboard.writeText(currentPromptContent);
                const success = document.getElementById('copySuccess');
                success.style.display = 'block';
                setTimeout(() => { success.style.display = 'none'; }, 2000);
            } catch (e) {
                alert('Failed to copy prompt.');
            }
        }

        document.getElementById('promptModal').addEventListener('click', (e) => {
            if (e.target.id === 'promptModal') closePromptModal();
        });
    </script>
</body>
</html>

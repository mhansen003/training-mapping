<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoanBeam Workbook Analysis - Process Workflow</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0f1a;
            --bg-secondary: #111827;
            --bg-card: #1a2234;
            --accent-blue: #3b82f6;
            --accent-teal: #14b8a6;
            --accent-amber: #f59e0b;
            --accent-rose: #f43f5e;
            --accent-green: #22c55e;
            --accent-purple: #8b5cf6;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-subtle: rgba(255,255,255,0.08);
            --sidebar-width: 280px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Breadcrumb */
        .breadcrumb {
            background: linear-gradient(90deg, #0d1525 0%, #1a2234 100%);
            padding: 14px 25px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.95rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1001;
            border-bottom: 1px solid var(--border-subtle);
        }

        .breadcrumb a {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 600;
            padding: 8px 16px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            transition: all 0.2s;
            border: 1px solid var(--border-subtle);
        }

        .breadcrumb a:hover {
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent-blue);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .breadcrumb .separator { color: var(--text-muted); font-size: 1.2rem; }
        .breadcrumb .current { color: var(--accent-amber); font-weight: 600; padding: 8px 16px; }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 54px;
            left: 0;
            width: var(--sidebar-width);
            height: calc(100vh - 54px);
            background: var(--bg-secondary);
            overflow-y: auto;
            z-index: 1000;
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 25px 20px;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid var(--border-subtle);
        }

        .sidebar-header h2 { color: var(--text-primary); font-size: 1.2rem; font-weight: 700; margin-bottom: 5px; }
        .sidebar-header p { color: var(--text-muted); font-size: 0.85rem; }

        /* Tab Switch */
        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-subtle);
        }

        .sidebar-tab {
            flex: 1;
            padding: 14px 10px;
            text-align: center;
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
            background: none;
            border-left: none;
            border-right: none;
            border-top: none;
        }

        .sidebar-tab:hover { background: rgba(255,255,255,0.03); color: var(--text-secondary); }
        .sidebar-tab.active { color: var(--accent-blue); border-bottom-color: var(--accent-blue); background: rgba(59, 130, 246, 0.08); }
        .sidebar-tab.agent-tab.active { color: var(--accent-purple); border-bottom-color: var(--accent-purple); background: rgba(139, 92, 246, 0.08); }

        .sidebar-nav { padding: 15px 0; flex: 1; overflow-y: auto; }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            color: var(--text-secondary);
            text-decoration: none;
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .nav-item:hover { background: rgba(255,255,255,0.03); color: var(--text-primary); }
        .nav-item.active { background: rgba(59, 130, 246, 0.1); border-left-color: var(--accent-blue); color: var(--text-primary); }

        .nav-number {
            background: rgba(255,255,255,0.1);
            color: var(--text-secondary);
            width: 28px;
            height: 28px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .nav-item.active .nav-number { background: var(--accent-blue); color: white; }
        .nav-label { font-size: 0.9rem; font-weight: 500; }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid var(--border-subtle);
            background: rgba(0,0,0,0.2);
        }

        .doc-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 14px 20px;
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-teal) 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            text-decoration: none;
            font-size: 0.95rem;
        }

        .doc-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3); }

        /* Main Content */
        .main-content { margin-left: var(--sidebar-width); padding: 80px 40px 40px 40px; }

        /* Tab Panels */
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        .header {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            padding: 35px;
            border-radius: 16px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(20, 184, 166, 0.08) 0%, transparent 50%);
            pointer-events: none;
        }

        .header h1 {
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 10px;
            position: relative;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-blue) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header .subtitle { color: var(--text-secondary); font-size: 1.1rem; position: relative; }

        .header .meta { display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap; position: relative; }

        .header .meta-item {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-subtle);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Legend */
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            padding: 18px 22px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            margin-bottom: 25px;
        }

        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--text-secondary); }
        .legend-color { width: 18px; height: 18px; border-radius: 4px; }

        /* Sections */
        .section {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            margin-bottom: 25px;
            overflow: hidden;
            scroll-margin-top: 75px;
        }

        .section-header {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(59, 130, 246, 0.1) 100%);
            border-bottom: 1px solid var(--border-subtle);
            padding: 22px 25px;
            display: flex;
            align-items: center;
            gap: 18px;
        }

        .section-number {
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-teal) 100%);
            color: white;
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1.3rem;
            flex-shrink: 0;
        }

        .section-title h2 { font-size: 1.35rem; font-weight: 700; margin-bottom: 4px; color: var(--text-primary); }
        .section-title span { font-size: 0.9rem; color: var(--text-muted); }
        .section-content { padding: 28px; }

        /* Tables */
        .field-table { width: 100%; border-collapse: collapse; margin: 18px 0; }

        .field-table th {
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent-blue);
            padding: 14px 18px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border-subtle);
        }

        .field-table td { padding: 14px 18px; border-bottom: 1px solid var(--border-subtle); color: var(--text-secondary); }
        .field-table tr:hover { background: rgba(255,255,255,0.02); }

        .badge { display: inline-block; padding: 4px 12px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
        .badge.fnma-badge { background: rgba(59, 130, 246, 0.15); color: var(--accent-blue); }
        .badge.fhlmc-badge { background: rgba(34, 197, 94, 0.15); color: var(--accent-green); }
        .badge.both-badge { background: rgba(139, 92, 246, 0.15); color: var(--accent-purple); }
        .badge.required-badge { background: rgba(244, 63, 94, 0.15); color: var(--accent-rose); }

        /* Info Boxes */
        .exception-box, .tip-box, .info-box {
            padding: 18px 22px;
            margin: 18px 0;
            border-radius: 0 10px 10px 0;
            border-left-width: 4px;
            border-left-style: solid;
        }

        .exception-box { background: rgba(244, 63, 94, 0.08); border-color: var(--accent-rose); border: 1px solid rgba(244, 63, 94, 0.2); border-left: 4px solid var(--accent-rose); }
        .exception-box h4 { color: var(--accent-rose); margin-bottom: 10px; font-size: 1rem; }
        .exception-box p, .exception-box li { color: var(--text-secondary); }

        .tip-box { background: rgba(34, 197, 94, 0.08); border-color: var(--accent-green); border: 1px solid rgba(34, 197, 94, 0.2); border-left: 4px solid var(--accent-green); }
        .tip-box h4 { color: var(--accent-green); margin-bottom: 10px; font-size: 1rem; }
        .tip-box p, .tip-box li { color: var(--text-secondary); }

        .info-box { background: rgba(59, 130, 246, 0.08); border-color: var(--accent-blue); border: 1px solid rgba(59, 130, 246, 0.2); border-left: 4px solid var(--accent-blue); }
        .info-box h4 { color: var(--accent-blue); margin-bottom: 10px; font-size: 1rem; }
        .info-box p, .info-box li { color: var(--text-secondary); }

        /* Tab Cards Grid */
        .tab-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin: 22px 0; }

        .tab-card {
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 22px;
            transition: all 0.2s;
        }

        .tab-card:hover { border-color: rgba(59, 130, 246, 0.3); transform: translateY(-2px); }

        .tab-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .tab-card-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-teal) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .tab-card-title { font-size: 1rem; font-weight: 700; color: var(--text-primary); }
        .tab-card-desc { font-size: 0.9rem; color: var(--text-muted); line-height: 1.5; }

        /* Workflow Diagrams */
        .workflow-diagram {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 28px;
            margin-bottom: 22px;
        }

        .flow-row { display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px; margin: 15px 0; }

        .flow-node {
            padding: 14px 22px;
            border-radius: 10px;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 600;
            min-width: 150px;
            border: 1px solid var(--border-subtle);
        }

        .flow-node.start { background: linear-gradient(135deg, var(--accent-green) 0%, #16a34a 100%); color: white; border-radius: 25px; border: none; }
        .flow-node.action { background: linear-gradient(135deg, var(--accent-blue) 0%, #2563eb 100%); color: white; border: none; }
        .flow-node.decision { background: linear-gradient(135deg, var(--accent-blue) 0%, #2563eb 100%); color: white; border: none; }
        .flow-node.input { background: var(--bg-secondary); border: 2px solid var(--accent-blue); color: var(--text-primary); }
        .flow-node.output { background: linear-gradient(135deg, var(--accent-teal) 0%, #0d9488 100%); color: white; border: none; }
        .flow-node.exception { background: linear-gradient(135deg, var(--accent-rose) 0%, #dc2626 100%); color: white; border: none; }

        .flow-arrow { color: var(--accent-blue); font-size: 1.5rem; }
        .flow-arrow.down { transform: rotate(90deg); }

        .decision-branch { display: flex; gap: 40px; justify-content: center; margin: 20px 0; flex-wrap: wrap; }
        .branch { display: flex; flex-direction: column; align-items: center; gap: 10px; }

        .branch-label {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--text-secondary);
        }

        /* Quick Reference */
        .quick-ref {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
            border: 1px solid var(--border-subtle);
            padding: 28px;
            border-radius: 16px;
            margin-top: 30px;
            font-family: 'JetBrains Mono', monospace;
        }

        .quick-ref h3 { color: var(--accent-blue); margin-bottom: 18px; font-family: 'Plus Jakarta Sans', sans-serif; }
        .quick-ref pre { background: rgba(0,0,0,0.4); border: 1px solid var(--border-subtle); padding: 20px; border-radius: 10px; overflow-x: auto; font-size: 0.85rem; line-height: 1.7; color: var(--text-secondary); }
        .quick-ref ol { margin-left: 20px; color: var(--text-secondary); }
        .quick-ref li { margin: 8px 0; }

        /* Comparison Table */
        .comparison-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin: 22px 0; }

        .comparison-card {
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            overflow: hidden;
        }

        .comparison-header {
            padding: 18px;
            text-align: center;
            font-weight: 700;
        }

        .comparison-header.fnma { background: linear-gradient(135deg, var(--accent-blue) 0%, #2563eb 100%); color: white; }
        .comparison-header.fhlmc { background: linear-gradient(135deg, var(--accent-green) 0%, #16a34a 100%); color: white; }

        .comparison-body { padding: 22px; }
        .comparison-body ul { list-style: none; padding: 0; }
        .comparison-body li { padding: 10px 0; border-bottom: 1px solid var(--border-subtle); color: var(--text-secondary); font-size: 0.9rem; display: flex; align-items: center; gap: 10px; }
        .comparison-body li:last-child { border-bottom: none; }

        /* Agent Styles */
        .agent-header {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            padding: 35px;
            border-radius: 16px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .agent-header::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(139, 92, 246, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(245, 158, 11, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .agent-header h1 {
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 10px;
            position: relative;
            background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-amber) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .agent-header .subtitle { color: var(--text-secondary); font-size: 1.1rem; position: relative; }

        .agent-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 35px;
        }

        .agent-summary-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 14px;
            padding: 25px;
            text-align: center;
        }

        .agent-summary-value {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-amber) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .agent-summary-label { font-size: 0.9rem; color: var(--text-muted); margin-top: 8px; }

        .heat-legend {
            display: flex;
            gap: 25px;
            padding: 18px 22px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .heat-legend-item { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; color: var(--text-secondary); }
        .heat-legend-color { width: 24px; height: 24px; border-radius: 6px; }

        .heat-map-container { margin-bottom: 35px; }
        .heat-map-title { font-size: 1.3rem; font-weight: 700; color: var(--text-primary); margin-bottom: 20px; display: flex; align-items: center; gap: 12px; }

        .heat-map-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .heat-item {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 20px;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .heat-item:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }

        .heat-item::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
        .heat-item.critical::before { background: linear-gradient(90deg, #ef4444, #f97316); }
        .heat-item.high::before { background: linear-gradient(90deg, #f97316, #eab308); }
        .heat-item.medium::before { background: linear-gradient(90deg, #eab308, #22c55e); }

        .heat-score { position: absolute; top: 15px; right: 15px; font-size: 1.8rem; font-weight: 800; }
        .heat-item.critical .heat-score { color: #ef4444; }
        .heat-item.high .heat-score { color: #f97316; }
        .heat-item.medium .heat-score { color: #eab308; }

        .heat-name { font-size: 1rem; font-weight: 700; color: var(--text-primary); margin-bottom: 6px; padding-right: 50px; }
        .heat-desc { font-size: 0.85rem; color: var(--text-muted); }

        .agent-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 25px; margin-bottom: 35px; }

        .agent-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .agent-card:hover { transform: translateY(-5px); box-shadow: 0 15px 50px rgba(0,0,0,0.3); }

        .agent-card.highlight { animation: highlightPulse 2s ease; box-shadow: 0 0 0 3px var(--accent-purple), 0 15px 50px rgba(139, 92, 246, 0.4); }

        @keyframes highlightPulse {
            0% { box-shadow: 0 0 0 3px var(--accent-purple), 0 15px 50px rgba(139, 92, 246, 0.6); }
            50% { box-shadow: 0 0 0 6px rgba(139, 92, 246, 0.5), 0 15px 50px rgba(139, 92, 246, 0.3); }
            100% { box-shadow: 0 0 0 0px transparent, 0 15px 50px rgba(0,0,0,0.3); }
        }

        .agent-card-header {
            padding: 22px;
            display: flex;
            align-items: flex-start;
            gap: 18px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .agent-icon {
            width: 55px;
            height: 55px;
            background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-amber) 100%);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            flex-shrink: 0;
        }

        .agent-info { flex: 1; }
        .agent-name { font-size: 1.15rem; font-weight: 700; color: var(--text-primary); margin-bottom: 5px; }
        .agent-type { font-size: 0.8rem; color: var(--accent-purple); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }

        .agent-priority { padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .agent-priority.critical { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
        .agent-priority.high { background: rgba(249, 115, 22, 0.15); color: #f97316; }
        .agent-priority.medium { background: rgba(234, 179, 8, 0.15); color: #eab308; }

        .agent-card-body { padding: 22px; }
        .agent-description { font-size: 0.95rem; color: var(--text-secondary); line-height: 1.6; margin-bottom: 20px; }

        .agent-flow { background: rgba(0,0,0,0.3); border: 1px solid var(--border-subtle); border-radius: 10px; padding: 18px; margin-bottom: 20px; }
        .agent-flow-title { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .agent-flow-diagram { display: flex; align-items: center; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .agent-step { background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-amber) 100%); color: white; padding: 8px 14px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; white-space: nowrap; }
        .agent-arrow { color: var(--accent-purple); font-size: 1.2rem; }

        .agent-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .agent-stat { background: rgba(0,0,0,0.2); border-radius: 8px; padding: 12px; text-align: center; }
        .agent-stat-value { font-size: 1.3rem; font-weight: 800; background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-amber) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .agent-stat-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-top: 4px; }

        .agent-prompt-btn {
            width: 100%;
            margin-top: 18px;
            padding: 14px 20px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(245, 158, 11, 0.2) 100%);
            border: 1px solid rgba(139, 92, 246, 0.4);
            border-radius: 10px;
            color: var(--accent-purple);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 0.9rem;
        }

        .agent-prompt-btn:hover {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3) 0%, rgba(245, 158, 11, 0.3) 100%);
            border-color: var(--accent-purple);
            transform: translateY(-2px);
        }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(10, 15, 26, 0.9); z-index: 2000; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(5px); }
        .modal-overlay.show { display: flex; }
        .modal { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 16px; width: 100%; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 25px 80px rgba(0,0,0,0.5); }
        .modal-header { background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-amber) 100%); color: white; padding: 22px 28px; display: flex; justify-content: space-between; align-items: center; border-radius: 16px 16px 0 0; }
        .modal-header h3 { font-size: 1.25rem; font-weight: 700; }
        .modal-close { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; background: rgba(255,255,255,0.2); color: white; font-size: 0.9rem; }
        .modal-body { padding: 28px; overflow-y: auto; flex: 1; }
        .prompt-section { margin-bottom: 25px; }
        .prompt-section h4 { color: var(--accent-purple); font-size: 1rem; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .prompt-box { background: rgba(0,0,0,0.4); border: 1px solid var(--border-subtle); border-radius: 10px; padding: 20px; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; line-height: 1.7; color: var(--text-secondary); white-space: pre-wrap; word-wrap: break-word; }
        .prompt-tags { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .prompt-tag { background: rgba(139, 92, 246, 0.15); color: var(--accent-purple); padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .copy-prompt-btn { background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-amber) 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; margin-top: 15px; }
        .copy-prompt-btn:hover { transform: scale(1.05); }

        #copySuccess { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--accent-green); color: white; padding: 18px 35px; border-radius: 10px; font-weight: 700; z-index: 3000; display: none; }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; }
            .agent-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Breadcrumb -->
    <nav class="breadcrumb">
        <a href="../../index.html">üè† Portal Home</a>
        <span class="separator">‚Ä∫</span>
        <a href="./index.html">üìä LoanBeam</a>
        <span class="separator">‚Ä∫</span>
        <span class="current">üìë Workbook Analysis</span>
    </nav>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>Workbook Analysis</h2>
            <p>Income tabs & calculations</p>
        </div>

        <div class="sidebar-tabs">
            <button class="sidebar-tab active" onclick="switchTab('workflow')">üìä Workflow</button>
            <button class="sidebar-tab agent-tab" onclick="switchTab('agents')">ü§ñ AI Agents</button>
        </div>

        <nav class="sidebar-nav" id="workflowNav">
            <a class="nav-item active" href="#structure">
                <span class="nav-number">1</span>
                <span class="nav-label">Workbook Structure</span>
            </a>
            <a class="nav-item" href="#cover-page">
                <span class="nav-number">2</span>
                <span class="nav-label">Cover Page</span>
            </a>
            <a class="nav-item" href="#summary-sheet">
                <span class="nav-number">3</span>
                <span class="nav-label">Summary Sheet</span>
            </a>
            <a class="nav-item" href="#main-sheet">
                <span class="nav-number">4</span>
                <span class="nav-label">Main Sheet</span>
            </a>
            <a class="nav-item" href="#income-tabs">
                <span class="nav-number">5</span>
                <span class="nav-label">Income Tabs</span>
            </a>
            <a class="nav-item" href="#manual-overrides">
                <span class="nav-number">6</span>
                <span class="nav-label">Manual Overrides</span>
            </a>
            <a class="nav-item" href="#liquidity">
                <span class="nav-number">7</span>
                <span class="nav-label">Liquidity Analysis</span>
            </a>
            <a class="nav-item" href="#transcripts">
                <span class="nav-number">8</span>
                <span class="nav-label">Transcript Comparison</span>
            </a>
            <a class="nav-item" href="#excel-to-pdf">
                <span class="nav-number">9</span>
                <span class="nav-label">Excel to PDF</span>
            </a>
        </nav>

        <nav class="sidebar-nav" id="agentNav" style="display: none;">
            <a class="nav-item" href="#agent-income-analyzer">
                <span class="nav-number">ü§ñ</span>
                <span class="nav-label">Income Analyzer</span>
            </a>
            <a class="nav-item" href="#agent-override-validator">
                <span class="nav-number">ü§ñ</span>
                <span class="nav-label">Override Validator</span>
            </a>
            <a class="nav-item" href="#agent-liquidity-checker">
                <span class="nav-number">ü§ñ</span>
                <span class="nav-label">Liquidity Checker</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <a href="./index.html" class="doc-btn">‚Üê Back to LoanBeam</a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Workflow Tab -->
        <div class="tab-panel active" id="workflowPanel">
            <div class="header">
                <h1>üìë LoanBeam Workbook Analysis</h1>
                <p class="subtitle">Understanding workbook structure, income calculation tabs, manual overrides, and liquidity analysis features</p>
                <div class="meta">
                    <span class="meta-item">üë§ Processor / Underwriter</span>
                    <span class="meta-item">‚è±Ô∏è 15-30 min review time</span>
                    <span class="meta-item">üìÑ Source: Workbook User Guide</span>
                </div>
            </div>

            <!-- Section 1: Workbook Structure -->
            <section class="section" id="structure">
                <div class="section-header">
                    <div class="section-number">1</div>
                    <div class="section-title">
                        <h2>Workbook Structure Overview</h2>
                        <span>Understanding the Excel workbook layout</span>
                    </div>
                </div>
                <div class="section-content">
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">LoanBeam workbooks are Excel files containing multiple tabs organized by income type. The structure varies slightly between FNMA Form 1084 and Freddie Mac Form 91 outputs.</p>

                    <div class="tab-grid">
                        <div class="tab-card">
                            <div class="tab-card-header">
                                <div class="tab-card-icon">üìã</div>
                                <div class="tab-card-title">Cover Page</div>
                            </div>
                            <div class="tab-card-desc">Reference number, borrower info, and document summary</div>
                        </div>
                        <div class="tab-card">
                            <div class="tab-card-header">
                                <div class="tab-card-icon">üìä</div>
                                <div class="tab-card-title">Summary Sheet</div>
                            </div>
                            <div class="tab-card-desc">Form 1084 (FNMA) or Form 91 (FHLMC) qualifying income</div>
                        </div>
                        <div class="tab-card">
                            <div class="tab-card-header">
                                <div class="tab-card-icon">üìù</div>
                                <div class="tab-card-title">Main Sheet</div>
                            </div>
                            <div class="tab-card-desc">Detailed line-by-line tax return data extraction</div>
                        </div>
                        <div class="tab-card">
                            <div class="tab-card-header">
                                <div class="tab-card-icon">üíº</div>
                                <div class="tab-card-title">Income Tabs</div>
                            </div>
                            <div class="tab-card-desc">Schedule C, E, F, K-1, Trust, Partnership, S-Corp, Corp</div>
                        </div>
                        <div class="tab-card">
                            <div class="tab-card-header">
                                <div class="tab-card-icon">üíß</div>
                                <div class="tab-card-title">Liquidity Analysis</div>
                            </div>
                            <div class="tab-card-desc">Current and Quick Ratio calculations for businesses</div>
                        </div>
                        <div class="tab-card">
                            <div class="tab-card-header">
                                <div class="tab-card-icon">üîç</div>
                                <div class="tab-card-title">Transcript Comparison</div>
                            </div>
                            <div class="tab-card-desc">Side-by-side tax return vs. IRS transcript data</div>
                        </div>
                    </div>

                    <div class="comparison-grid">
                        <div class="comparison-card">
                            <div class="comparison-header fnma">FNMA Form 1084</div>
                            <div class="comparison-body">
                                <ul>
                                    <li>‚úì Fannie Mae SEI calculation format</li>
                                    <li>‚úì Trending income analysis included</li>
                                    <li>‚úì No LPA integration</li>
                                    <li>‚úì Cannot be re-uploaded after edits</li>
                                </ul>
                            </div>
                        </div>
                        <div class="comparison-card">
                            <div class="comparison-header fhlmc">Freddie Mac Form 91</div>
                            <div class="comparison-body">
                                <ul>
                                    <li>‚úì Freddie Mac calculation format</li>
                                    <li>‚úì Reference Number for LPA</li>
                                    <li>‚úì Rep & Warranty relief eligible</li>
                                    <li>‚úì Can upload edited workbook for new ref#</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Section 2: Cover Page -->
            <section class="section" id="cover-page">
                <div class="section-header">
                    <div class="section-number">2</div>
                    <div class="section-title">
                        <h2>Cover Page</h2>
                        <span>Reference information and document summary</span>
                    </div>
                </div>
                <div class="section-content">
                    <table class="field-table">
                        <thead>
                            <tr>
                                <th>Field</th>
                                <th>Description</th>
                                <th>Format</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Reference Number</strong></td>
                                <td>Unique identifier for LPA submission (Form 91 only)</td>
                                <td>LB-XXXXXXXX</td>
                            </tr>
                            <tr>
                                <td><strong>Borrower Name</strong></td>
                                <td>Primary borrower as entered in application</td>
                                <td>Text</td>
                            </tr>
                            <tr>
                                <td><strong>Co-Borrower Name</strong></td>
                                <td>Co-borrower if applicable</td>
                                <td>Text</td>
                            </tr>
                            <tr>
                                <td><strong>Loan Number</strong></td>
                                <td>CLEAR loan number for reference</td>
                                <td>Numeric</td>
                            </tr>
                            <tr>
                                <td><strong>Documents Processed</strong></td>
                                <td>List of all tax forms included in analysis</td>
                                <td>List with years</td>
                            </tr>
                            <tr>
                                <td><strong>Processing Date</strong></td>
                                <td>Date workbook was generated</td>
                                <td>MM/DD/YYYY</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="tip-box">
                        <h4>üí° Reference Number Location</h4>
                        <p>The Reference Number is prominently displayed on the Cover Page. For Form 91 workbooks, this number must be entered into Freddie Mac's Loan Product Advisor to receive Rep & Warranty relief on income calculations.</p>
                    </div>
                </div>
            </section>

            <!-- Section 3: Summary Sheet -->
            <section class="section" id="summary-sheet">
                <div class="section-header">
                    <div class="section-number">3</div>
                    <div class="section-title">
                        <h2>Summary Sheet</h2>
                        <span>Form 1084 / Form 91 qualifying income calculation</span>
                    </div>
                </div>
                <div class="section-content">
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">The Summary Sheet presents the final qualifying income in the standard GSE format. This is the primary output for underwriting review.</p>

                    <table class="field-table">
                        <thead>
                            <tr>
                                <th>Income Source</th>
                                <th>Calculation Method</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>W-2 Income</strong></td>
                                <td>Averaged from 2 years or YTD if trending up</td>
                                <td>Base, overtime, bonus, commissions</td>
                            </tr>
                            <tr>
                                <td><strong>Schedule C (Self-Employment)</strong></td>
                                <td>Net profit + depreciation + other adjustments</td>
                                <td>See Income Tabs for details</td>
                            </tr>
                            <tr>
                                <td><strong>Schedule E (Rental)</strong></td>
                                <td>Net rental income with depreciation add-back</td>
                                <td>75% of gross rent for qualifying</td>
                            </tr>
                            <tr>
                                <td><strong>K-1 Income</strong></td>
                                <td>Ordinary income + adjustments by entity type</td>
                                <td>Partnership, S-Corp, or Trust</td>
                            </tr>
                            <tr>
                                <td><strong>Interest/Dividends</strong></td>
                                <td>Averaged if consistent 2-year history</td>
                                <td>May require asset documentation</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="info-box">
                        <h4>üî¢ Calculation Transparency</h4>
                        <p>Each income figure on the Summary Sheet includes a hyperlink to the detailed calculation tab. Click any income amount to navigate directly to the supporting calculation.</p>
                    </div>
                </div>
            </section>

            <!-- Section 4: Main Sheet -->
            <section class="section" id="main-sheet">
                <div class="section-header">
                    <div class="section-number">4</div>
                    <div class="section-title">
                        <h2>Main Sheet</h2>
                        <span>Line-by-line tax return data extraction</span>
                    </div>
                </div>
                <div class="section-content">
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">The Main Sheet displays extracted data from each tax form with source document references. This is the raw data that feeds into income calculations.</p>

                    <h3 style="color: var(--accent-blue); margin: 25px 0 15px;">Source Document References</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 15px;">Each cell containing extracted data includes a comment with:</p>

                    <table class="field-table">
                        <thead>
                            <tr>
                                <th>Reference Element</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Page Number</strong></td>
                                <td>Specific page in the uploaded PDF where data was found</td>
                            </tr>
                            <tr>
                                <td><strong>Form Line</strong></td>
                                <td>Line number on the tax form (e.g., "Line 31" for Schedule C net profit)</td>
                            </tr>
                            <tr>
                                <td><strong>Confidence Score</strong></td>
                                <td>OCR confidence percentage for the extracted value</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="tip-box">
                        <h4>üí° Verifying Data</h4>
                        <p>Hover over any cell with a red triangle indicator to see the source reference. This allows you to quickly verify any value against the original document.</p>
                    </div>
                </div>
            </section>

            <!-- Section 5: Income Tabs -->
            <section class="section" id="income-tabs">
                <div class="section-header">
                    <div class="section-number">5</div>
                    <div class="section-title">
                        <h2>Income Calculation Tabs</h2>
                        <span>Detailed calculations by income type</span>
                    </div>
                </div>
                <div class="section-content">
                    <div class="tab-grid">
                        <div class="tab-card">
                            <div class="tab-card-header">
                                <div class="tab-card-icon">üìä</div>
                                <div class="tab-card-title">Schedule C</div>
                            </div>
                            <div class="tab-card-desc">Self-employment income from sole proprietorships. Includes depreciation, depletion, amortization add-backs, business miles, and meals/entertainment adjustments.</div>
                        </div>
                        <div class="tab-card">
                            <div class="tab-card-header">
                                <div class="tab-card-icon">üè†</div>
                                <div class="tab-card-title">Schedule E (Rental)</div>
                            </div>
                            <div class="tab-card-desc">Rental real estate income. Calculates net operating income with depreciation add-back. Supports multiple properties and 75% rental income for qualifying.</div>
                        </div>
                        <div class="tab-card">
                            <div class="tab-card-header">
                                <div class="tab-card-icon">üíé</div>
                                <div class="tab-card-title">Schedule E (Royalty)</div>
                            </div>
                            <div class="tab-card-desc">Royalty income from oil, gas, minerals, or intellectual property. Separate tab for royalty-specific calculations and depletion adjustments.</div>
                        </div>
                        <div class="tab-card">
                            <div class="tab-card-header">
                                <div class="tab-card-icon">üåæ</div>
                                <div class="tab-card-title">Schedule F (Farm)</div>
                            </div>
                            <div class="tab-card-desc">Farm income calculation. Handles agricultural-specific deductions, conservation expenses, and commodity credit loans.</div>
                        </div>
                        <div class="tab-card">
                            <div class="tab-card-header">
                                <div class="tab-card-icon">ü§ù</div>
                                <div class="tab-card-title">Partnership (1065)</div>
                            </div>
                            <div class="tab-card-desc">K-1 income from partnerships. Includes ordinary income, guaranteed payments, and capital gain distributions. Requires liquidity analysis.</div>
                        </div>
                        <div class="tab-card">
                            <div class="tab-card-header">
                                <div class="tab-card-icon">üè¢</div>
                                <div class="tab-card-title">S Corporation (1120S)</div>
                            </div>
                            <div class="tab-card-desc">K-1 income from S Corporations. W-2 wages plus distributions and share of ordinary income. Requires liquidity analysis for ownership >25%.</div>
                        </div>
                        <div class="tab-card">
                            <div class="tab-card-header">
                                <div class="tab-card-icon">üèõÔ∏è</div>
                                <div class="tab-card-title">Corporation (1120)</div>
                            </div>
                            <div class="tab-card-desc">Corporate income for majority shareholders. Analyzes retained earnings, dividends, and officer compensation.</div>
                        </div>
                        <div class="tab-card">
                            <div class="tab-card-header">
                                <div class="tab-card-icon">üìú</div>
                                <div class="tab-card-title">Trust</div>
                            </div>
                            <div class="tab-card-desc">Trust income distributions. K-1 from Form 1041 showing beneficiary's share of trust income.</div>
                        </div>
                    </div>

                    <div class="info-box">
                        <h4>üîÑ Repeated Income Groups</h4>
                        <p>When a borrower has multiple businesses of the same type (e.g., 3 rental properties), each appears as a separate group within the same tab. Groups are labeled (1), (2), (3), etc.</p>
                    </div>
                </div>
            </section>

            <!-- Section 6: Manual Overrides -->
            <section class="section" id="manual-overrides">
                <div class="section-header">
                    <div class="section-number">6</div>
                    <div class="section-title">
                        <h2>Manual Overrides</h2>
                        <span>Making corrections and adjustments</span>
                    </div>
                </div>
                <div class="section-content">
                    <div class="workflow-diagram">
                        <div class="flow-row">
                            <div class="flow-node start">Identify Error</div>
                            <span class="flow-arrow">‚Üí</span>
                            <div class="flow-node action">Navigate to Tab</div>
                            <span class="flow-arrow">‚Üí</span>
                            <div class="flow-node input">Enter Override Value</div>
                            <span class="flow-arrow">‚Üí</span>
                            <div class="flow-node output">Recalculates Automatically</div>
                        </div>
                    </div>

                    <table class="field-table">
                        <thead>
                            <tr>
                                <th>Override Type</th>
                                <th>When to Use</th>
                                <th>Effect</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Value Override</strong></td>
                                <td>OCR misread a number</td>
                                <td>Replaces extracted value, recalculates downstream</td>
                            </tr>
                            <tr>
                                <td><strong>Exclusion Override</strong></td>
                                <td>Income source shouldn't be counted</td>
                                <td>Removes income from qualifying total</td>
                            </tr>
                            <tr>
                                <td><strong>Add-back Override</strong></td>
                                <td>Non-recurring expense needs manual add-back</td>
                                <td>Increases qualifying income</td>
                            </tr>
                            <tr>
                                <td><strong>Calculation Override</strong></td>
                                <td>Different averaging method required</td>
                                <td>Changes how income is averaged</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="exception-box">
                        <h4>‚ö†Ô∏è Override Documentation</h4>
                        <p>All manual overrides must be documented in the loan file with an explanation of why the change was made. Overrides affect the Reference Number validity - re-upload the edited workbook to get a new Reference Number that reflects your changes.</p>
                    </div>

                    <div class="tip-box">
                        <h4>üí° Yellow Highlighted Cells</h4>
                        <p>Cells that accept manual overrides are highlighted in yellow. Simply click the cell and type your corrected value. The workbook will automatically recalculate all dependent fields.</p>
                    </div>
                </div>
            </section>

            <!-- Section 7: Liquidity Analysis -->
            <section class="section" id="liquidity">
                <div class="section-header">
                    <div class="section-number">7</div>
                    <div class="section-title">
                        <h2>Liquidity Analysis</h2>
                        <span>Business viability assessment for partnerships and S-Corps</span>
                    </div>
                </div>
                <div class="section-content">
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">When a borrower owns >25% of a Partnership or S Corporation, GSE guidelines require a liquidity analysis to ensure the business can sustain distributions used for qualifying.</p>

                    <table class="field-table">
                        <thead>
                            <tr>
                                <th>Ratio</th>
                                <th>Formula</th>
                                <th>Minimum Required</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Current Ratio</strong></td>
                                <td>Current Assets √∑ Current Liabilities</td>
                                <td>‚â• 1.0</td>
                            </tr>
                            <tr>
                                <td><strong>Quick Ratio</strong></td>
                                <td>(Current Assets - Inventory) √∑ Current Liabilities</td>
                                <td>‚â• 1.0</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="info-box">
                        <h4>üìä Liquidity Tab</h4>
                        <p>The Liquidity Analysis tab automatically extracts balance sheet data from business tax returns and calculates both ratios. If either ratio is below 1.0, the business income may not be usable for qualifying without additional compensating factors.</p>
                    </div>

                    <div class="exception-box">
                        <h4>‚ö†Ô∏è When Liquidity Fails</h4>
                        <p>If Current or Quick Ratio is below 1.0, consider: (1) requesting updated balance sheet showing improvement, (2) reducing the qualifying income amount, or (3) documenting compensating factors such as strong personal reserves.</p>
                    </div>
                </div>
            </section>

            <!-- Section 8: Transcript Comparison -->
            <section class="section" id="transcripts">
                <div class="section-header">
                    <div class="section-number">8</div>
                    <div class="section-title">
                        <h2>Transcript Comparison</h2>
                        <span>Validating tax returns against IRS records</span>
                    </div>
                </div>
                <div class="section-content">
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">When IRS transcripts are uploaded alongside tax returns, LoanBeam performs an automated comparison to identify any discrepancies.</p>

                    <div class="workflow-diagram">
                        <div class="flow-row">
                            <div class="flow-node input">Upload Tax Return</div>
                            <span class="flow-arrow">‚Üí</span>
                            <div class="flow-node input">Upload IRS Transcript</div>
                            <span class="flow-arrow">‚Üí</span>
                            <div class="flow-node action">Automated Comparison</div>
                            <span class="flow-arrow">‚Üí</span>
                            <div class="flow-node decision">Variances?</div>
                        </div>
                        <div class="decision-branch">
                            <div class="branch">
                                <span class="branch-label">No</span>
                                <div class="flow-node output">Validated ‚úì</div>
                            </div>
                            <div class="branch">
                                <span class="branch-label">Yes</span>
                                <div class="flow-node exception">Review Required</div>
                            </div>
                        </div>
                    </div>

                    <table class="field-table">
                        <thead>
                            <tr>
                                <th>Comparison Field</th>
                                <th>Tax Return Source</th>
                                <th>Transcript Source</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>AGI</strong></td>
                                <td>Form 1040, Line 11</td>
                                <td>Transcript AGI field</td>
                            </tr>
                            <tr>
                                <td><strong>W-2 Wages</strong></td>
                                <td>Form 1040, Line 1</td>
                                <td>Transcript wages field</td>
                            </tr>
                            <tr>
                                <td><strong>Schedule C Profit</strong></td>
                                <td>Schedule C, Line 31</td>
                                <td>Transcript SE income</td>
                            </tr>
                            <tr>
                                <td><strong>Filing Status</strong></td>
                                <td>Form 1040 checkbox</td>
                                <td>Transcript filing status</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="tip-box">
                        <h4>üí° Tolerance Thresholds</h4>
                        <p>Minor rounding differences (typically under $100) are marked as acceptable variances. Significant discrepancies are flagged in red and require investigation before proceeding.</p>
                    </div>
                </div>
            </section>

            <!-- Section 9: Excel to PDF -->
            <section class="section" id="excel-to-pdf">
                <div class="section-header">
                    <div class="section-number">9</div>
                    <div class="section-title">
                        <h2>Excel to PDF Conversion</h2>
                        <span>Saving workbooks for file submission</span>
                    </div>
                </div>
                <div class="section-content">
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">Many lenders require PDF versions of income workbooks for loan file documentation. Follow these steps to properly save your LoanBeam workbook as a PDF.</p>

                    <div class="quick-ref">
                        <h3>üìã 7-Step PDF Conversion Process</h3>
                        <ol>
                            <li><strong>Open the workbook</strong> in Microsoft Excel</li>
                            <li>Click <strong>File</strong> in the menu bar</li>
                            <li>Select <strong>Save As</strong> (or Export on Mac)</li>
                            <li>Choose your <strong>save location</strong></li>
                            <li>Change <strong>Save as type</strong> to "PDF (*.pdf)"</li>
                            <li>Click <strong>Options</strong> and select "Entire workbook"</li>
                            <li>Click <strong>Save</strong> to create the PDF</li>
                        </ol>
                    </div>

                    <div class="tip-box">
                        <h4>üí° Important: Entire Workbook</h4>
                        <p>Make sure to select "Entire workbook" in the Options dialog. This ensures all tabs (including income calculations and source references) are included in the PDF, not just the active sheet.</p>
                    </div>

                    <div class="info-box">
                        <h4>üìÑ PDF Naming Convention</h4>
                        <p>Recommended naming format: <code>LoanBeam_[BorrowerLastName]_[LoanNumber]_[Date].pdf</code></p>
                        <p style="margin-top: 8px;">Example: <code>LoanBeam_Smith_12345678_20260126.pdf</code></p>
                    </div>
                </div>
            </section>

        </div>

        <!-- Agent Opportunities Tab -->
        <div class="tab-panel" id="agentPanel">
            <div class="agent-header">
                <h1>ü§ñ AI Agent Opportunities</h1>
                <p class="subtitle">Automation opportunities for LoanBeam Workbook Analysis</p>
            </div>

            <div class="agent-summary">
                <div class="agent-summary-card">
                    <div class="agent-summary-value">3</div>
                    <div class="agent-summary-label">Agent Opportunities</div>
                </div>
                <div class="agent-summary-card">
                    <div class="agent-summary-value">55%</div>
                    <div class="agent-summary-label">Automation Potential</div>
                </div>
                <div class="agent-summary-card">
                    <div class="agent-summary-value">High</div>
                    <div class="agent-summary-label">Accuracy Impact</div>
                </div>
            </div>

            <div class="heat-legend">
                <div class="heat-legend-item">
                    <div class="heat-legend-color" style="background: linear-gradient(135deg, #ef4444, #f97316);"></div>
                    <span>Critical (9-10)</span>
                </div>
                <div class="heat-legend-item">
                    <div class="heat-legend-color" style="background: linear-gradient(135deg, #f97316, #eab308);"></div>
                    <span>High (7-8)</span>
                </div>
                <div class="heat-legend-item">
                    <div class="heat-legend-color" style="background: linear-gradient(135deg, #eab308, #22c55e);"></div>
                    <span>Medium (5-6)</span>
                </div>
            </div>

            <div class="heat-map-container">
                <h3 class="heat-map-title">üìä Priority Heat Map</h3>
                <div class="heat-map-grid">
                    <div class="heat-item critical" onclick="scrollToAgent('agent-income-analyzer')">
                        <div class="heat-score">9</div>
                        <div class="heat-name">Income Analyzer Agent</div>
                        <div class="heat-desc">Automated income consistency review</div>
                    </div>
                    <div class="heat-item high" onclick="scrollToAgent('agent-override-validator')">
                        <div class="heat-score">8</div>
                        <div class="heat-name">Override Validator Agent</div>
                        <div class="heat-desc">Manual override audit trail</div>
                    </div>
                    <div class="heat-item medium" onclick="scrollToAgent('agent-liquidity-checker')">
                        <div class="heat-score">6</div>
                        <div class="heat-name">Liquidity Checker Agent</div>
                        <div class="heat-desc">Business viability assessment</div>
                    </div>
                </div>
            </div>

            <div class="agent-grid">
                <!-- Income Analyzer Agent -->
                <div class="agent-card" id="agent-income-analyzer">
                    <div class="agent-card-header">
                        <div class="agent-icon">üìä</div>
                        <div class="agent-info">
                            <div class="agent-name">Income Analyzer Agent</div>
                            <div class="agent-type">Analysis Agent</div>
                        </div>
                        <span class="agent-priority critical">Critical</span>
                    </div>
                    <div class="agent-card-body">
                        <p class="agent-description">Analyzes income trends across tax years, identifies inconsistencies, flags declining income patterns, and provides narrative explanations for underwriter review. Reduces income calculation review time by 40%.</p>

                        <div class="agent-flow">
                            <div class="agent-flow-title">Agent Workflow</div>
                            <div class="agent-flow-diagram">
                                <span class="agent-step">Parse Workbook</span>
                                <span class="agent-arrow">‚Üí</span>
                                <span class="agent-step">Trend Analysis</span>
                                <span class="agent-arrow">‚Üí</span>
                                <span class="agent-step">Flag Issues</span>
                                <span class="agent-arrow">‚Üí</span>
                                <span class="agent-step">Generate Report</span>
                            </div>
                        </div>

                        <div class="agent-stats">
                            <div class="agent-stat">
                                <div class="agent-stat-value">40%</div>
                                <div class="agent-stat-label">Time Savings</div>
                            </div>
                            <div class="agent-stat">
                                <div class="agent-stat-value">95%</div>
                                <div class="agent-stat-label">Issue Detection</div>
                            </div>
                            <div class="agent-stat">
                                <div class="agent-stat-value">Auto</div>
                                <div class="agent-stat-label">Narrative</div>
                            </div>
                        </div>

                        <button class="agent-prompt-btn" onclick="openPromptModal('income-analyzer')">üîÆ View AI Prompt</button>
                    </div>
                </div>

                <!-- Override Validator Agent -->
                <div class="agent-card" id="agent-override-validator">
                    <div class="agent-card-header">
                        <div class="agent-icon">‚úÖ</div>
                        <div class="agent-info">
                            <div class="agent-name">Override Validator Agent</div>
                            <div class="agent-type">Compliance Agent</div>
                        </div>
                        <span class="agent-priority high">High</span>
                    </div>
                    <div class="agent-card-body">
                        <p class="agent-description">Tracks all manual overrides made to workbooks, validates against source documents, generates audit trail documentation, and ensures overrides are properly justified for QC review.</p>

                        <div class="agent-flow">
                            <div class="agent-flow-title">Agent Workflow</div>
                            <div class="agent-flow-diagram">
                                <span class="agent-step">Detect Overrides</span>
                                <span class="agent-arrow">‚Üí</span>
                                <span class="agent-step">Match to Source</span>
                                <span class="agent-arrow">‚Üí</span>
                                <span class="agent-step">Validate</span>
                                <span class="agent-arrow">‚Üí</span>
                                <span class="agent-step">Audit Log</span>
                            </div>
                        </div>

                        <div class="agent-stats">
                            <div class="agent-stat">
                                <div class="agent-stat-value">100%</div>
                                <div class="agent-stat-label">Override Tracking</div>
                            </div>
                            <div class="agent-stat">
                                <div class="agent-stat-value">Auto</div>
                                <div class="agent-stat-label">Audit Trail</div>
                            </div>
                            <div class="agent-stat">
                                <div class="agent-stat-value">QC</div>
                                <div class="agent-stat-label">Ready</div>
                            </div>
                        </div>

                        <button class="agent-prompt-btn" onclick="openPromptModal('override-validator')">üîÆ View AI Prompt</button>
                    </div>
                </div>

                <!-- Liquidity Checker Agent -->
                <div class="agent-card" id="agent-liquidity-checker">
                    <div class="agent-card-header">
                        <div class="agent-icon">üíß</div>
                        <div class="agent-info">
                            <div class="agent-name">Liquidity Checker Agent</div>
                            <div class="agent-type">Risk Assessment Agent</div>
                        </div>
                        <span class="agent-priority medium">Medium</span>
                    </div>
                    <div class="agent-card-body">
                        <p class="agent-description">Evaluates business liquidity ratios, compares against GSE requirements, identifies compensating factors when ratios are below threshold, and generates condition recommendations.</p>

                        <div class="agent-flow">
                            <div class="agent-flow-title">Agent Workflow</div>
                            <div class="agent-flow-diagram">
                                <span class="agent-step">Extract Ratios</span>
                                <span class="agent-arrow">‚Üí</span>
                                <span class="agent-step">Compare Threshold</span>
                                <span class="agent-arrow">‚Üí</span>
                                <span class="agent-step">Find Compensating</span>
                                <span class="agent-arrow">‚Üí</span>
                                <span class="agent-step">Recommend</span>
                            </div>
                        </div>

                        <div class="agent-stats">
                            <div class="agent-stat">
                                <div class="agent-stat-value">Auto</div>
                                <div class="agent-stat-label">Ratio Calc</div>
                            </div>
                            <div class="agent-stat">
                                <div class="agent-stat-value">GSE</div>
                                <div class="agent-stat-label">Compliant</div>
                            </div>
                            <div class="agent-stat">
                                <div class="agent-stat-value">Risk</div>
                                <div class="agent-stat-label">Assessment</div>
                            </div>
                        </div>

                        <button class="agent-prompt-btn" onclick="openPromptModal('liquidity-checker')">üîÆ View AI Prompt</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Prompt Modal -->
    <div class="modal-overlay" id="promptModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">ü§ñ AI Agent Prompt</h3>
                <button class="modal-close" onclick="closePromptModal()">‚úï Close</button>
            </div>
            <div class="modal-body">
                <div class="prompt-tags" id="promptTags"></div>
                <div class="prompt-section">
                    <h4>üìù System Prompt</h4>
                    <div class="prompt-box" id="promptContent"></div>
                </div>
                <button class="copy-prompt-btn" onclick="copyPrompt()">üìã Copy Prompt</button>
            </div>
        </div>
    </div>

    <div id="copySuccess">‚úì Copied to clipboard!</div>

    <script>
        function switchTab(tab) {
            document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));

            if (tab === 'workflow') {
                document.querySelector('.sidebar-tab:not(.agent-tab)').classList.add('active');
                document.getElementById('workflowPanel').classList.add('active');
                document.getElementById('workflowNav').style.display = 'block';
                document.getElementById('agentNav').style.display = 'none';
            } else {
                document.querySelector('.sidebar-tab.agent-tab').classList.add('active');
                document.getElementById('agentPanel').classList.add('active');
                document.getElementById('workflowNav').style.display = 'none';
                document.getElementById('agentNav').style.display = 'block';
            }
        }

        const sections = document.querySelectorAll('.section');
        const navItems = document.querySelectorAll('#workflowNav .nav-item');
        let isScrolling = false;
        let scrollTimeout;

        // Prevent scroll-spy from interfering during navigation clicks
        navItems.forEach(item => {
            item.addEventListener('click', (e) => {
                isScrolling = true;
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => { isScrolling = false; }, 1000);
            });
        });

        window.addEventListener('scroll', () => {
            if (isScrolling) return;

            let current = '';
            const scrollPosition = window.scrollY + 150;

            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                const sectionBottom = sectionTop + section.offsetHeight;

                if (scrollPosition >= sectionTop && scrollPosition < sectionBottom) {
                    current = section.getAttribute('id');
                }
            });

            if (current) {
                navItems.forEach(item => {
                    item.classList.remove('active');
                    if (item.getAttribute('href') === '#' + current) {
                        item.classList.add('active');
                    }
                });
            }
        });

        function scrollToAgent(agentId) {
            switchTab('agents');
            setTimeout(() => {
                const agent = document.getElementById(agentId);
                agent.scrollIntoView({ behavior: 'smooth', block: 'center' });
                agent.classList.add('highlight');
                setTimeout(() => agent.classList.remove('highlight'), 2000);
            }, 100);
        }

        const prompts = {
            'income-analyzer': {
                title: 'Income Analyzer Agent',
                tags: ['Analysis', 'Trending', 'Income Calculation', 'Underwriting'],
                prompt: `You are an Income Analysis Agent for LoanBeam workbook review.

TASK: Analyze income calculations from a LoanBeam workbook and provide underwriter-ready insights.

ANALYSIS STEPS:
1. Income Trend Analysis
   - Compare Year 1 vs Year 2 income for each source
   - Calculate percentage change
   - Flag declining trends (>10% decrease)
   - Note significant increases requiring explanation

2. Consistency Checks
   - Verify W-2 income matches tax return
   - Check Schedule C gross receipts trend
   - Validate K-1 distributions are consistent
   - Compare rental income to lease agreements if available

3. Red Flag Detection
   - Declining business income
   - Large one-time income items
   - Missing tax year data
   - Unusual deduction patterns

4. Narrative Generation
   - Write underwriter-friendly explanation of income
   - Highlight any concerns with context
   - Provide supporting calculations
   - Suggest conditions if needed

OUTPUT FORMAT:
{
  "income_summary": {
    "total_qualifying": "$XX,XXX/month",
    "primary_sources": ["W-2", "Schedule C", etc.],
    "trend": "STABLE|INCREASING|DECLINING"
  },
  "analysis": {
    "w2_income": { "year1": "$", "year2": "$", "change": "%", "assessment": "" },
    "self_employment": { "year1": "$", "year2": "$", "change": "%", "assessment": "" },
    "rental": { "year1": "$", "year2": "$", "change": "%", "assessment": "" }
  },
  "red_flags": [],
  "narrative": "Plain English explanation...",
  "recommended_conditions": []
}

Be thorough but concise. Focus on what matters for underwriting.`
            },
            'override-validator': {
                title: 'Override Validator Agent',
                tags: ['Compliance', 'Audit', 'Documentation', 'QC'],
                prompt: `You are an Override Validation Agent for LoanBeam workbooks.

TASK: Detect, validate, and document all manual overrides made to a LoanBeam workbook.

DETECTION PROCESS:
1. Compare original OCR values to current values
2. Identify all cells that have been manually changed
3. Note the original value, new value, and cell location

VALIDATION STEPS:
1. For each override, attempt to verify against source documents
2. Check if the override value matches what's visible in the tax document
3. Assess if the override is reasonable given context

DOCUMENTATION:
Create an audit trail entry for each override:
- What was changed (field name, original, new)
- Why it was likely changed (OCR error, interpretation, adjustment)
- Whether it can be verified from source
- Impact on qualifying income

OUTPUT FORMAT:
{
  "override_count": X,
  "overrides": [
    {
      "location": "Tab name, Cell reference",
      "field": "Description of field",
      "original_value": "$X,XXX",
      "new_value": "$X,XXX",
      "change_type": "CORRECTION|ADJUSTMENT|EXCLUSION",
      "verifiable": true|false,
      "income_impact": "+/- $X,XXX annual",
      "justification_needed": true|false
    }
  ],
  "total_income_impact": "+/- $X,XXX annual",
  "audit_summary": "Plain English summary for QC review",
  "documentation_complete": true|false
}

Flag any overrides that lack clear justification.`
            },
            'liquidity-checker': {
                title: 'Liquidity Checker Agent',
                tags: ['Risk Assessment', 'Business Analysis', 'GSE Compliance'],
                prompt: `You are a Liquidity Analysis Agent for LoanBeam workbooks.

TASK: Evaluate business liquidity for Partnership and S-Corporation income.

EXTRACTION:
From the business tax return, extract:
- Current Assets (cash, receivables, inventory)
- Current Liabilities (payables, short-term debt)
- Inventory value (for Quick Ratio)

CALCULATIONS:
1. Current Ratio = Current Assets / Current Liabilities
2. Quick Ratio = (Current Assets - Inventory) / Current Liabilities

THRESHOLD ASSESSMENT:
- GSE requirement: Both ratios ‚â• 1.0
- Marginal: 0.8 - 1.0 (may need compensating factors)
- Failing: < 0.8 (income likely not usable)

COMPENSATING FACTORS:
If ratios are below threshold, look for:
- Strong personal liquid reserves
- Consistent distribution history
- Improving trend year-over-year
- Seasonal business with timing explanation
- Line of credit availability

OUTPUT FORMAT:
{
  "business_name": "Entity name",
  "ownership_percentage": "XX%",
  "current_ratio": X.XX,
  "quick_ratio": X.XX,
  "status": "PASS|MARGINAL|FAIL",
  "compensating_factors_found": [],
  "recommendation": "USE|CONDITION|EXCLUDE",
  "condition_language": "If applicable...",
  "underwriter_notes": "Summary explanation"
}

Always provide clear guidance on usability of the income.`
            }
        };

        function openPromptModal(promptId) {
            const data = prompts[promptId];
            document.getElementById('modalTitle').textContent = 'ü§ñ ' + data.title;
            document.getElementById('promptTags').innerHTML = data.tags.map(t => `<span class="prompt-tag">${t}</span>`).join('');
            document.getElementById('promptContent').textContent = data.prompt;
            document.getElementById('promptModal').classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closePromptModal() {
            document.getElementById('promptModal').classList.remove('show');
            document.body.style.overflow = '';
        }

        async function copyPrompt() {
            const prompt = document.getElementById('promptContent').textContent;
            try {
                await navigator.clipboard.writeText(prompt);
                document.getElementById('copySuccess').style.display = 'block';
                setTimeout(() => { document.getElementById('copySuccess').style.display = 'none'; }, 2000);
            } catch (e) {
                alert('Failed to copy prompt.');
            }
        }

        document.getElementById('promptModal').addEventListener('click', (e) => {
            if (e.target.id === 'promptModal') closePromptModal();
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closePromptModal();
        });
    </script>
</body>
</html>
